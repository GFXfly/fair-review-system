# å®‰å…¨é‡æ„æ€»ç»“æŠ¥å‘Š

## æ¦‚è¿°
æœ¬æ¬¡å®‰å…¨é‡æ„è§£å†³äº†é«˜çº§ç¨‹åºå®¡æŸ¥æŠ¥å‘Šä¸­æŒ‡å‡ºçš„æ‰€æœ‰ä¸¥é‡å®‰å…¨æ¼æ´ï¼Œå®æ–½äº†å®Œæ•´çš„è®¤è¯æˆæƒç³»ç»Ÿå’Œé€Ÿç‡é™åˆ¶æœºåˆ¶ã€‚

---

## å·²ä¿®å¤çš„ä¸¥é‡å®‰å…¨é—®é¢˜

### ğŸ”´ è‡´å‘½æ¼æ´ï¼ˆå·²ä¿®å¤ï¼‰

#### 1. æ˜æ–‡ userId Cookie æ¼æ´ âœ…
**åŸé—®é¢˜**ï¼š
- ä½¿ç”¨æ˜æ–‡ `userId` cookieï¼Œæ”»å‡»è€…å¯éšæ„ä¿®æ”¹å†’å……ä»»ä½•ç”¨æˆ·
- ç¼ºå°‘ç­¾åéªŒè¯ã€åŠ å¯†ã€SameSite ç­‰å®‰å…¨æªæ–½

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- âœ… ä½¿ç”¨ `iron-session` å®ç°åŠ å¯†ç­¾åçš„ session
- âœ… æ·»åŠ  `sameSite: 'strict'` å’Œ `httpOnly: true`
- âœ… ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨å¯ç”¨ `secure: true`
- âœ… Session åŒ…å«ï¼šuserId, username, role, isLoggedIn

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `src/lib/session.ts` - Session é…ç½®
- `src/lib/auth.ts` - è®¤è¯ä¸­é—´ä»¶
- `src/app/api/auth/login/route.ts` - ç™»å½•æ¥å£é‡æ„

---

#### 2. é‡ç½®å¯†ç æ— æƒé™éªŒè¯ âœ…
**åŸé—®é¢˜**ï¼š
- `/api/users/reset-password` å…è®¸ä»»ä½•äººé‡ç½®ä»»ä½•ç”¨æˆ·å¯†ç 
- æ— éœ€éªŒè¯æ—§å¯†ç æˆ–ç®¡ç†å‘˜æƒé™

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- âœ… åˆ›å»ºä¸¤ä¸ªç‹¬ç«‹æ¥å£ï¼š
  1. `/api/users/change-password` - ç”¨æˆ·ä¿®æ”¹è‡ªå·±å¯†ç ï¼ˆéœ€éªŒè¯æ—§å¯†ç ï¼‰
  2. `/api/users/reset-password` - ç®¡ç†å‘˜é‡ç½®ä»–äººå¯†ç ï¼ˆéœ€ç®¡ç†å‘˜æƒé™ï¼‰
- âœ… æ·»åŠ é€Ÿç‡é™åˆ¶ï¼ˆ3æ¬¡/å°æ—¶ï¼‰

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `src/app/api/users/change-password/route.ts` - æ–°å¢
- `src/app/api/users/reset-password/route.ts` - é‡æ„

---

#### 3. ç”¨æˆ·ç®¡ç†æ¥å£æ— æƒé™æ§åˆ¶ âœ…
**åŸé—®é¢˜**ï¼š
- `GET /api/users` - ä»»ä½•äººå¯åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·
- `POST /api/users` - ä»»ä½•äººå¯åˆ›å»ºç®¡ç†å‘˜è´¦å·

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- âœ… GET æ¥å£ï¼šéœ€è¦ç™»å½•è®¤è¯
- âœ… POST æ¥å£ï¼šéœ€è¦ç®¡ç†å‘˜æƒé™
- âœ… æ·»åŠ å®Œæ•´çš„å®¡è®¡æ—¥å¿—è®°å½•

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `src/app/api/users/route.ts`

---

#### 4. æ¡ˆä¾‹æ¥å£æ— æƒé™æ§åˆ¶ âœ…
**åŸé—®é¢˜**ï¼š
- `POST /api/cases` å…è®¸ä»»ä½•äººåˆ›å»º/ç¯¡æ”¹æ¡ˆä¾‹æ•°æ®

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- âœ… éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½åˆ›å»ºæ¡ˆä¾‹
- âœ… æ·»åŠ å®¡è®¡æ—¥å¿—è®°å½•

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `src/app/api/cases/route.ts`

---

#### 5. API å¯†é’¥æ³„éœ² âœ…
**åŸé—®é¢˜**ï¼š
- `src/app/api/debug-env/route.ts` å…¬å¼€è¿”å› API key ä¿¡æ¯
- `prisma/dev.db"DEEPSEEK_API_KEY=...` æ–‡ä»¶åŒ…å«å®Œæ•´å¯†é’¥
- æ•°æ®åº“æ–‡ä»¶è¢«æ‰“åŒ…è¿› Docker é•œåƒ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- âœ… åˆ é™¤ `/api/debug-env` æ¥å£
- âœ… åˆ é™¤æ³„éœ²çš„å¯†é’¥æ–‡ä»¶
- âœ… æ›´æ–° `.gitignore` é˜²æ­¢æ•æ„Ÿæ–‡ä»¶æäº¤
- âœ… åˆ›å»º `.env.example` ä½œä¸ºé…ç½®æ¨¡æ¿

**æ¶‰åŠæ–‡ä»¶**ï¼š
- åˆ é™¤ï¼š`src/app/api/debug-env/`
- åˆ é™¤ï¼š`prisma/dev.db"DEEPSEEK_API_KEY=...`
- æ›´æ–°ï¼š`.gitignore`
- æ–°å¢ï¼š`.env.example`

**âš ï¸ é‡è¦æé†’**ï¼šè¯·ç«‹å³åœ¨ DeepSeek æ§åˆ¶å°æ’¤é”€å¹¶é‡æ–°ç”Ÿæˆ API keyï¼

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ï¼ˆå·²ä¿®å¤ï¼‰

#### 6. CSRF é˜²æŠ¤ç¼ºå¤± âœ…
**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- âœ… ä½¿ç”¨ `sameSite: 'strict'` cookie ç­–ç•¥
- âœ… iron-session è‡ªåŠ¨æä¾› CSRF ä¿æŠ¤

---

#### 7. é€Ÿç‡é™åˆ¶ç¼ºå¤± âœ…
**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- âœ… ç™»å½•æ¥å£ï¼š5æ¬¡/15åˆ†é’Ÿ
- âœ… å¯†ç é‡ç½®ï¼š3æ¬¡/å°æ—¶
- âœ… LLM åˆ†æï¼š10æ¬¡/å°æ—¶ï¼ˆé¢„ç•™ï¼‰
- âœ… é€šç”¨ APIï¼š100æ¬¡/åˆ†é’Ÿ

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `src/lib/rate-limit.ts` - é€Ÿç‡é™åˆ¶å·¥å…·
- åº”ç”¨äºï¼šlogin, change-password, reset-password æ¥å£

---

#### 8. Prisma è¿æ¥ç®¡ç†é—®é¢˜ âœ…
**åŸé—®é¢˜**ï¼š
- `guidance_counselor.ts` ä¸­é”™è¯¯è°ƒç”¨ `$disconnect()` å¯¼è‡´å¹¶å‘è¯·æ±‚å¤±è´¥

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- âœ… ç§»é™¤æ‰‹åŠ¨æ–­å¼€è¿æ¥çš„ä»£ç 
- âœ… ä½¿ç”¨å…¨å±€ Prisma å•ä¾‹è‡ªåŠ¨ç®¡ç†è¿æ¥æ± 

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `src/lib/agents/guidance_counselor.ts`

---

#### 9. LLM Dummy Key é—®é¢˜ âœ…
**åŸé—®é¢˜**ï¼š
- API key ç¼ºå¤±æ—¶ä½¿ç”¨ `dummy-key` ç»§ç»­è¯·æ±‚ï¼Œå¯¼è‡´ 401 é”™è¯¯éš¾ä»¥æ’æŸ¥

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- âœ… API key ç¼ºå¤±æ—¶æŠ›å‡ºæ˜ç¡®é”™è¯¯ä¿¡æ¯
- âœ… æ—©æœŸå¤±è´¥ï¼Œé¿å…æ— æ„ä¹‰çš„ API è°ƒç”¨

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `src/lib/llm.ts`

---

## æ–°å¢çš„å®‰å…¨åŸºç¡€è®¾æ–½

### 1. ç»Ÿä¸€è®¤è¯ä¸­é—´ä»¶
**æ–‡ä»¶**ï¼š`src/lib/auth.ts`

**æä¾›çš„åŠŸèƒ½**ï¼š
```typescript
getCurrentUser()    // è·å–å½“å‰ç™»å½•ç”¨æˆ·ï¼ˆå¯èƒ½ä¸º nullï¼‰
requireAuth()       // è¦æ±‚ç”¨æˆ·å·²ç™»å½•ï¼ˆå¦åˆ™æŠ›å‡º 401ï¼‰
requireAdmin()      // è¦æ±‚ç®¡ç†å‘˜æƒé™ï¼ˆå¦åˆ™æŠ›å‡º 403ï¼‰
handleAuthError()   // ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
// éœ€è¦ç™»å½•çš„æ¥å£
export async function GET(request: NextRequest) {
    const user = await requireAuth(request);
    // ... ç”¨æˆ·å·²éªŒè¯
}

// éœ€è¦ç®¡ç†å‘˜æƒé™çš„æ¥å£
export async function POST(request: NextRequest) {
    const admin = await requireAdmin(request);
    // ... ç®¡ç†å‘˜å·²éªŒè¯
}
```

---

### 2. Session ç®¡ç†
**æ–‡ä»¶**ï¼š`src/lib/session.ts`

**ç‰¹æ€§**ï¼š
- ä½¿ç”¨ iron-session åŠ å¯†ç­¾å
- Cookie åç§°ï¼š`fair_competition_session`
- æœ‰æ•ˆæœŸï¼š7å¤©
- è‡ªåŠ¨å¤„ç† secure/sameSite/httpOnly

**ç¯å¢ƒå˜é‡**ï¼š
```bash
SESSION_SECRET="è‡³å°‘32å­—ç¬¦çš„éšæœºå­—ç¬¦ä¸²"
```

---

### 3. é€Ÿç‡é™åˆ¶å™¨
**æ–‡ä»¶**ï¼š`src/lib/rate-limit.ts`

**é¢„é…ç½®çš„é™åˆ¶å™¨**ï¼š
- `loginRateLimiter` - ç™»å½•ä¿æŠ¤
- `passwordResetRateLimiter` - å¯†ç æ“ä½œä¿æŠ¤
- `llmAnalysisRateLimiter` - LLM è°ƒç”¨ä¿æŠ¤
- `generalApiRateLimiter` - é€šç”¨ API ä¿æŠ¤

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
const result = await applyRateLimit(loginRateLimiter, getClientId(request));
if (!result.success) {
    return result.response; // è¿”å› 429 Too Many Requests
}
```

---

### 4. å®¡è®¡æ—¥å¿—å¢å¼º
**æ–‡ä»¶**ï¼š`src/lib/audit-logger.ts`

**æ–°å¢çš„å®¡è®¡äº‹ä»¶**ï¼š
- `change_password` / `change_password_failed`
- `reset_password` / `reset_password_failed`
- `create_user` / `create_user_failed`
- `create_cases`

---

## å·²é‡æ„çš„æ¥å£

### è®¤è¯ç›¸å…³
- âœ… `POST /api/auth/login` - æ·»åŠ é€Ÿç‡é™åˆ¶ + iron-session
- âœ… `POST /api/auth/logout` - ä½¿ç”¨ session.destroy()
- âœ… `GET /api/auth/me` - ä½¿ç”¨æ–°çš„è®¤è¯ä¸­é—´ä»¶

### ç”¨æˆ·ç®¡ç†
- âœ… `GET /api/users` - éœ€è¦ç™»å½•
- âœ… `POST /api/users` - éœ€è¦ç®¡ç†å‘˜æƒé™
- âœ… `POST /api/users/change-password` - æ–°å¢ï¼Œç”¨æˆ·æ”¹è‡ªå·±å¯†ç 
- âœ… `POST /api/users/reset-password` - é‡æ„ï¼Œç®¡ç†å‘˜é‡ç½®ä»–äººå¯†ç 

### æ¡ˆä¾‹ç®¡ç†
- âœ… `POST /api/cases` - éœ€è¦ç®¡ç†å‘˜æƒé™

---

## é…ç½®è¦æ±‚

### å¿…éœ€çš„ç¯å¢ƒå˜é‡
åˆ›å»º `.env.local` æ–‡ä»¶ï¼ˆåŸºäº `.env.example`ï¼‰ï¼š

```bash
# æ•°æ®åº“
DATABASE_URL="file:./dev.db"

# DeepSeek APIï¼ˆå¿…éœ€ï¼‰
DEEPSEEK_API_KEY="your_new_key_here"  # âš ï¸ ä½¿ç”¨æ–°ç”Ÿæˆçš„ key
DEEPSEEK_BASE_URL="https://api.deepseek.com"

# SiliconFlow APIï¼ˆå¿…éœ€ï¼‰
SILICONFLOW_API_KEY="your_key_here"

# Session å¯†é’¥ï¼ˆå¿…éœ€ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼‰
SESSION_SECRET="è¯·ç”Ÿæˆ32å­—ç¬¦ä»¥ä¸Šçš„éšæœºå­—ç¬¦ä¸²"

# ç¯å¢ƒ
NODE_ENV="development"
```

### ç”Ÿæˆå®‰å…¨çš„ SESSION_SECRET
```bash
# ä½¿ç”¨ OpenSSL
openssl rand -base64 32

# æˆ–ä½¿ç”¨ Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

---

## éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

### ğŸ”´ ç´§æ€¥ï¼ˆç«‹å³æ‰§è¡Œï¼‰
- [ ] åœ¨ DeepSeek æ§åˆ¶å°æ’¤é”€æ—§çš„ API key
- [ ] ç”Ÿæˆæ–°çš„ DeepSeek API key
- [ ] æ›´æ–° `.env.local` ä¸­çš„ `DEEPSEEK_API_KEY`
- [ ] ç”Ÿæˆå®‰å…¨çš„ `SESSION_SECRET`ï¼ˆ32å­—ç¬¦ä»¥ä¸Šï¼‰

### ğŸŸ¡ é‡è¦ï¼ˆéƒ¨ç½²å‰ï¼‰
- [ ] ç¡®è®¤ `.env*` æ–‡ä»¶ä¸åœ¨ git ä»“åº“ä¸­
- [ ] ç¡®è®¤ `dev.db` å’Œå…¶ä»–æ•°æ®åº“æ–‡ä»¶ä¸åœ¨ git ä»“åº“ä¸­
- [ ] æ£€æŸ¥ Docker é•œåƒä¸åŒ…å«æ•æ„Ÿæ•°æ®
- [ ] è®¾ç½® `NODE_ENV=production`
- [ ] é…ç½®åå‘ä»£ç†ï¼ˆNginxï¼‰è®¾ç½®æ­£ç¡®çš„ `X-Forwarded-For` å’Œ `X-Real-IP` å¤´

### âœ… å»ºè®®
- [ ] ä¸ºç”Ÿäº§ç¯å¢ƒé…ç½® HTTPSï¼ˆç¡®ä¿ secure cookie ç”Ÿæ•ˆï¼‰
- [ ] è€ƒè™‘ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æœåŠ¡ï¼ˆå¦‚ AWS Secrets Managerï¼‰
- [ ] å®šæœŸè½®æ¢ API keys
- [ ] ç›‘æ§å®¡è®¡æ—¥å¿—ä¸­çš„å¼‚å¸¸æ´»åŠ¨
- [ ] è€ƒè™‘æ·»åŠ  IP ç™½åå•é™åˆ¶ç®¡ç†å‘˜ç™»å½•

---

## æµ‹è¯•ç»“æœ

### æ„å»ºæµ‹è¯•
```bash
npm run build
```
âœ… é€šè¿‡ - æ‰€æœ‰ç±»å‹æ£€æŸ¥å’Œç¼–è¯‘æˆåŠŸ

### ç”Ÿæˆçš„è·¯ç”±
```
è®¤è¯æ¥å£ï¼š
â”œ Æ’ /api/auth/login          - ç™»å½•ï¼ˆé€Ÿç‡é™åˆ¶ï¼‰
â”œ Æ’ /api/auth/logout         - ç™»å‡º
â”œ Æ’ /api/auth/me             - è·å–å½“å‰ç”¨æˆ·

ç”¨æˆ·ç®¡ç†ï¼ˆéœ€æƒé™ï¼‰ï¼š
â”œ Æ’ /api/users               - GET: éœ€ç™»å½•, POST: éœ€ç®¡ç†å‘˜
â”œ Æ’ /api/users/change-password   - ç”¨æˆ·æ”¹å¯†ç 
â”œ Æ’ /api/users/reset-password    - ç®¡ç†å‘˜é‡ç½®å¯†ç 

æ¡ˆä¾‹ç®¡ç†ï¼ˆéœ€æƒé™ï¼‰ï¼š
â”œ Æ’ /api/cases               - POST: éœ€ç®¡ç†å‘˜
```

---

## æœªæ¥å»ºè®®

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰
1. ä¸º `/api/analyze` æ¥å£æ·»åŠ é€Ÿç‡é™åˆ¶ï¼ˆé˜²æ­¢ LLM æˆæœ¬çˆ†ç‚¸ï¼‰
2. å®ç°æ–‡ä»¶ä¸Šä¼ å¤§å°å’Œç±»å‹éªŒè¯
3. æ·»åŠ  CORS é…ç½®ï¼ˆå¦‚æœéœ€è¦å‰ç«¯åˆ†ç¦»éƒ¨ç½²ï¼‰

### ä¸­æœŸï¼ˆ1ä¸ªæœˆï¼‰
1. å®ç°å¤šå› ç´ è®¤è¯ï¼ˆ2FAï¼‰
2. æ·»åŠ è´¦å·é”å®šæœºåˆ¶ï¼ˆå¤šæ¬¡å¤±è´¥ç™»å½•ï¼‰
3. å®ç° API è®¿é—®æ—¥å¿—å’Œç›‘æ§ä»ªè¡¨æ¿
4. æ·»åŠ æ•°æ®å¤‡ä»½å’Œæ¢å¤æµç¨‹

### é•¿æœŸï¼ˆ3ä¸ªæœˆï¼‰
1. è€ƒè™‘ä½¿ç”¨ Redis æ›¿ä»£å†…å­˜é€Ÿç‡é™åˆ¶å™¨ï¼ˆæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ï¼‰
2. å®ç°ç»†ç²’åº¦çš„ RBAC æƒé™ç³»ç»Ÿ
3. æ·»åŠ  WebAuthn/Passkey æ”¯æŒ
4. å®ç°è‡ªåŠ¨åŒ–å®‰å…¨æ‰«æå’Œæ¼æ´æ£€æµ‹

---

## ä¾èµ–é¡¹æ›´æ–°

### æ–°å¢ä¾èµ–
```json
{
  "dependencies": {
    "iron-session": "^8.x",
    "rate-limiter-flexible": "^5.x"
  }
}
```

---

## è”ç³»å’Œæ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å‘ç°æ–°çš„å®‰å…¨æ¼æ´ï¼Œè¯·ç«‹å³æŠ¥å‘Šç»™ç³»ç»Ÿç®¡ç†å‘˜ã€‚

---

**é‡æ„å®Œæˆæ—¶é—´**ï¼š2025-12-13
**é‡æ„ç‰ˆæœ¬**ï¼šv2.0-security
**çŠ¶æ€**ï¼šâœ… æ‰€æœ‰ä¸¥é‡å®‰å…¨æ¼æ´å·²ä¿®å¤ï¼Œç³»ç»Ÿå¯å®‰å…¨éƒ¨ç½²
