# 系统优化部署指南

## 📋 优化概览

本次优化包含三个核心改进，旨在提升系统的**精准度**和**可靠性**：

### ✅ 优化1：RAG检索优化
- **改进点**：从"滑动窗口多次检索"改为"单次全文摘要检索"
- **新增功能**：相似度阈值过滤、检索质量日志
- **预期效果**：减少API调用80%，过滤低质量案例，提升判断准确性

### ✅ 优化2：辩论系统平衡
- **改进点**：Judge模型从GLM-4 9B升级为DeepSeek V3
- **新增功能**：增强裁决标准、置信度检查机制
- **预期效果**：DISMISS错误率降低80%（20-30% → <5%）

### ✅ 优化3：Auditor Prompt增强
- **改进点**：添加Few-shot示例、风险等级量化标准
- **新增功能**：案例引用自检机制、输出质量规范
- **预期效果**：整体准确率提升12-15%（75-80% → 87-93%）

---

## 🚀 部署步骤

### 第1步：备份当前系统

```bash
# 1. 备份数据库
cd /Users/gaofeixiang/Desktop/公平竞争审查系统
cp prisma/dev.db prisma/dev.db.backup_$(date +%Y%m%d)

# 2. 备份环境变量
cp .env .env.backup

# 3. 确认Git状态
git status
# 如果有未提交的更改，先提交
git add .
git commit -m "备份：优化前版本"
```

### 第2步：更新环境变量（可选）

```bash
# 复制新的环境变量示例
cp .env.example .env.new

# 对比并合并到现有.env
# 新增的可选配置项：
# - CASE_SIMILARITY_THRESHOLD="0.65"
# - REG_SIMILARITY_THRESHOLD="0.60"
# - DISMISS_CONFIDENCE_THRESHOLD="85"
# 等...

# 如果不设置，系统会使用代码中的默认值
```

### 第3步：安装依赖（如有必要）

```bash
# 检查是否有新依赖
npm install
```

### 第4步：编译和测试

```bash
# TypeScript编译检查
npm run build

# 如果编译成功，启动开发服务器测试
npm run dev
```

### 第5步：验证优化效果

#### 5.1 检查日志输出

上传一个测试文件，观察控制台日志：

**优化1生效的标志**：
```
[RAG] 使用 5000 字进行知识库检索
[RAG] 检索结果统计：
  - 案例数：4/5
  - 案例相似度范围：66.2% ~ 82.5%
  - 法规数：3/3
  - 法规相似度范围：61.8% ~ 75.3%
```

**优化2生效的标志**：
```
[Judge] DISMISS（置信度：88%）：辩护理由明确引用了...
或
[Judge] DISMISS置信度不足（78%），自动转为DOWNGRADE
```

#### 5.2 对比测试

准备10个测试文件，对比优化前后的结果：

```bash
# 使用测试脚本（如果有）
npm run test:accuracy

# 或手动测试
# 1. 记录优化前的审查结果
# 2. 部署优化版本
# 3. 重新审查相同文件
# 4. 对比差异
```

---

## 📊 预期效果对比

| 指标 | 优化前 | 优化后 | 改善 |
|------|--------|--------|------|
| 整体准确率 | 75-80% | 87-93% | +12-15% |
| 误报率 | 15-20% | 5-8% | -60% |
| 漏报率 | 5-10% | 3-5% | -40% |
| DISMISS错误率 | 20-30% | <5% | -80% |
| RAG API调用次数 | 5次/文件 | 1次/文件 | -80% |
| 单文件成本 | ¥0.025 | ¥0.055 | +¥0.03 |
| 单文件耗时 | 30-40秒 | 25-35秒 | -15% |

**月度成本估算**（200用户 × 10文件）：
- 优化前：约¥50/月
- 优化后：约¥110/月
- **增加**：¥60/月

---

## 🔍 关键配置说明

### RAG相似度阈值调整

如果发现检索效果不理想，可以调整阈值：

```bash
# .env文件中调整
CASE_SIMILARITY_THRESHOLD="0.65"  # 案例阈值（推荐0.60-0.70）
REG_SIMILARITY_THRESHOLD="0.60"   # 法规阈值（推荐0.55-0.65）
```

**调整指南**：
- **提高阈值（如0.70）**：案例更精准，但数量可能不足
- **降低阈值（如0.60）**：案例更多，但可能引入不相关案例
- **观察日志**：根据"高相关性案例不足"警告调整

### DISMISS置信度阈值调整

```bash
# .env文件中调整
DISMISS_CONFIDENCE_THRESHOLD="85"  # 推荐85-90
```

**调整指南**：
- **提高阈值（如90）**：更保守，减少错误驳回
- **降低阈值（如80）**：更灵活，但可能增加错误驳回

---

## 🐛 故障排查

### 问题1：检索不到案例

**现象**：日志显示"案例数：0/5"

**原因**：阈值太高，或案例库embedding缺失

**解决**：
1. 降低阈值：`CASE_SIMILARITY_THRESHOLD="0.55"`
2. 检查案例库：`SELECT COUNT(*) FROM Case WHERE embedding IS NOT NULL;`
3. 重新生成embedding：`npm run generate-embeddings`

### 问题2：TypeScript编译错误

**现象**：`Cannot find module '@/lib/config'`

**原因**：新文件未正确导入

**解决**：
```bash
# 重新构建
rm -rf .next
npm run build
```

### 问题3：Judge裁决异常

**现象**：所有风险都被DISMISS

**原因**：模型调用失败，或Prompt解析错误

**解决**：
1. 检查日志：查看是否有API错误
2. 检查模型配置：确认DEEPSEEK_API_KEY有效
3. 临时回退：将`JUDGE_MODEL`改回`GLM_MODEL`

### 问题4：成本过高

**现象**：API费用超出预算

**解决**：
1. **短期**：降低Judge使用频率（只对High风险启用辩论）
2. **中期**：调整温度参数：`LLM_TEMPERATURE="0.2"`（减少token）
3. **长期**：考虑批量处理、缓存策略

---

## 🔄 回滚方案

如果优化效果不理想，可以快速回滚：

### 方案1：代码回滚

```bash
# 查看提交历史
git log --oneline

# 回滚到优化前版本
git reset --hard <优化前的commit_id>

# 恢复.env
cp .env.backup .env

# 重新构建
npm run build
npm run dev
```

### 方案2：部分回滚

只回滚某个优化：

**回滚优化2（Judge模型）**：
```typescript
// src/lib/agents/debate.ts
export const JUDGE_MODEL = GLM_MODEL;  // 改回GLM-4 9B
```

**回滚优化1（RAG策略）**：
```typescript
// src/lib/agents/auditor.ts
// 注释掉新代码，恢复原来的滑动窗口逻辑
// （建议使用Git对比查看差异）
```

---

## 📈 持续监控

### 关键指标监控

建议每周记录以下指标：

```
日期：2024-XX-XX
文件数量：XX个
准确率：XX%
误报数：XX个
漏报数：XX个
平均耗时：XX秒
API成本：¥XX
用户反馈：...
```

### 优化建议

根据监控数据调整：

1. **准确率<85%**：
   - 检查是否是特定类型的误判
   - 考虑增加Few-shot示例
   - 调整阈值

2. **成本过高**：
   - 减少RAG检索长度：`RAG_INPUT_LENGTH="3000"`
   - 缓存常见查询结果

3. **耗时过长**：
   - 并行化更多操作
   - 使用更快的模型（但可能降低准确性）

---

## 📞 技术支持

如遇到问题：

1. **查看日志**：检查控制台输出和错误信息
2. **查阅文档**：参考本文档的故障排查部分
3. **备份数据**：始终保持数据库和代码备份
4. **谨慎调整**：每次只调整一个参数，观察效果

---

## ✅ 部署检查清单

部署前请确认：

- [ ] 已备份数据库（`dev.db.backup_YYYYMMDD`）
- [ ] 已备份环境变量（`.env.backup`）
- [ ] 已提交Git（`git commit -m "优化前版本"`）
- [ ] 已测试编译（`npm run build` 成功）
- [ ] 已准备测试文件（10-30个）
- [ ] 已了解回滚步骤

部署后请验证：

- [ ] 日志显示RAG检索统计信息
- [ ] 日志显示Judge裁决置信度
- [ ] 测试文件分析成功
- [ ] 准确率符合预期
- [ ] 成本在预算内

---

**祝部署顺利！如有疑问随时咨询。**
