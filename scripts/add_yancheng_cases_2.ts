import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
    console.log('开始添加盐城市公平竞争审查典型案例（二）...');

    // 0. 清理之前错误识别为"益阳"的数据（如果存在）
    const wrongReport = await prisma.report.findFirst({
        where: { title: { contains: '益阳市公平竞争审查典型案例（二）' } }
    });
    if (wrongReport) {
        await prisma.case.deleteMany({ where: { reportId: wrongReport.id } });
        await prisma.report.delete({ where: { id: wrongReport.id } });
        console.log('已清理错误的益阳市数据');
    }

    // 1. 创建正确的通报
    const reportData = {
        title: '盐城市公平竞争审查典型案例（二）',
        department: '盐城市市场监督管理局',
        publishDate: '2025-09-12',
        province: '江苏省'
    };

    let report = await prisma.report.findFirst({
        where: { title: reportData.title }
    });

    if (!report) {
        console.log('创建新通报:', reportData.title);
        report = await prisma.report.create({
            data: reportData
        });
    } else {
        console.log('使用已有通报, ID:', report.id);
        await prisma.case.deleteMany({
            where: { reportId: report.id }
        });
    }

    // 2. 添加4个案例
    const cases = [
        {
            title: '关于印发《XX地区不锈钢产业发展规划》限制外地商品进入本地市场案',
            content: `【文件名称】《XX地区不锈钢产业发展规划》
【违规内容】鼓励县域内企业优先采购本地不锈钢制品产品，支持政府公共采购在同等条件下优先购买本地企业产品。
【审查解析】违规内容鼓励本地企业优先采购本地不锈钢制品产品、支持政府招采优先购买本地企业产品的做法，直接排斥了外地同类产品平等参与本地市场竞争，是典型的限制外地或者进口商品、要素进入本地市场行为。
【处理结果】审查人员在监测中发现了该份违规文件，并及时向起草单位发送《整改提醒函》，目前该文件已经废止。`,
            violationType: '限制商品要素自由流动',
            result: '已整改',
            documentName: '《XX地区不锈钢产业发展规划》',
            documentOrg: '相关起草单位',
            violationClause: `《公平竞争审查条例》
第九条 起草单位起草的政策措施，不得含有下列限制商品、要素自由流动的内容：
（一）限制外地或者进口商品、要素进入本地市场，或者阻碍本地经营者迁出，商品、要素输出。`,
            violationDetail: '鼓励县域内企业优先采购本地不锈钢制品产品，支持政府公共采购在同等条件下优先购买本地企业产品。',
        },
        {
            title: '《XX地区畜禽粪污处理中心运行项目招标公告》强制外地经营者在本地设立分支机构案',
            content: `【文件名称】《XX地区畜禽粪污处理中心运行项目招标公告》
【违规内容】2.本项目的特定资格要求：2.1申请在弄污处理中心为投入建设符合环保、安全、带动村民就业的项目，且仅限于与畜禽粪污处理相关的经营项目，不得从事“两高”“危废”等涉及环保和安全的相关经营业务，且须成立工商注册地在本地区的生产经营公司作为运行主体。
【审查解析】不同于“限制外地经营者参加本地招标投标”标准，此公告并未直接禁止外地经营者竞标，而是在资格要求中变相限制需要在本地成立运营主体，因此适用“强制或者变相强制外地经营者在本地投资或设立分支机构”标准。
【处理结果】审查人员在监测中发现了该份违规文件，并及时向起草单位发送《整改提醒函》，因该招标公告被发现时已经实施完毕，起草部门承诺今后严格把关文件审查，确保各类市场主体公平参与竞争。`,
            violationType: '限制商品要素自由流动',
            result: '已整改',
            documentName: '《XX地区畜禽粪污处理中心运行项目招标公告》',
            documentOrg: '相关起草单位',
            violationClause: `《公平竞争审查条例》
第九条 起草单位起草的政策措施，不得含有下列限制商品、要素自由流动的内容：
（二）排斥、限制、强制或者变相强制外地经营者在本地投资经营或者设立分支机构。`,
            violationDetail: '要求须成立工商注册地在本地区的生产经营公司作为运行主体。',
        },
        {
            title: '《2025年“安全专家进企业”服务项目招标公告》限制外地经营者参加本地招标投标案',
            content: `【文件名称】《2025年“安全专家进企业”服务项目招标公告》
【违规内容】招标文件发放方式：现场购买；供应商凭借加盖公章的《单位介绍信》（介绍信格式自拟，需有联系人及联系方式）、营业执照（原件、复印件均可）自费手持光公章领取。
【审查解析】违规内容将招标文件发放方式限定为现场购买，为本地以外的潜在供应商参与本项目投标设置了障碍，变相限制了外地经营者参与本地招标投标。2025年新出台的《公平竞争审查条例实施办法》已明确“要求现场报名或者现场购买采购文件、招标文件等”是变相限制外地经营者参加本地政府采购的情形之一。
【处理结果】审查人员在监测中发现了该份违规文件并同时向监管部门和政府采购主管一部门进行通报。因该招标公告被发现时已处实施完毕，起草部门承诺今后严格把关文件审查，确保各类市场主体公平参与竞争。`,
            violationType: '限制商品要素自由流动',
            result: '已整改',
            documentName: '《2025年“安全专家进企业”服务项目招标公告》',
            documentOrg: '相关起草单位',
            violationClause: `《公平竞争审查条例实施办法》
第十五条
（六）设置不合理的公示时间、响应时间、要求现场报名或者现场购买采购文件、招标文件等，影响外地经营者参加本地政府采购、招标投标。`,
            violationDetail: '招标文件发放方式限定为现场购买。',
        },
        {
            title: '关于印发《XX地区建设工程消防验收技术服务机构管理办法（试行）》对外地经营者设置不合理标准案',
            content: `【文件名称】关于印发《XX地区建设工程消防验收技术服务机构管理办法（试行）》的通知
【违规内容】文件附件2《XX地区建设工程消防验收技术服务（消防验收备案抽查）机构信用评价计分方法》中：“…说明：2.在计分周期内获得的相关表扬、表彰、通报等，以正式发文的文件的发文日期为奖励日期…企业在盐城市范围以外获得的不在加分统计范围。”
《XX地区建设工程消防验收技术服务机构管理办法（试行）》第二十条…对信用等级为A级、B级的，合理降低抽查比例和频次；等级为C级的，实施强化监管和较高频次的日常监督检查，必要时将将其列入专项检查结果重点监管对象；等级为D级的，在行政管理和公共服务中作为重点监管对象。
【审查解析】违规内容限定了只有在盐城市范围内获得荣誉功绩才能采取相关加分，在外地发展良好企业无法使用其在外地获取的荣誉进行加分，直接导致信用评价得分相对低于本地企业，进而因信用评价得分结果的差异，使得外地企业在接受监管频次等方面受到不平等待遇，涉嫌违反《公平竞争审查条例》第九条：“起草单位起草的政策措施，不得含有下列限制商品、要素自由流动的内容：（五）在资质标准、监管执法等方面对外地经营者在本地投资经营设置歧视性要求。”
【处理结果】审查人员在公平竞争审查抽查中发现了该份违规文件，目前正在与发文单位对接整改事宜。`,
            violationType: '限制商品要素自由流动',
            result: '整改中',
            documentName: '《XX地区建设工程消防验收技术服务机构管理办法（试行）》',
            documentOrg: '相关发文单位',
            violationClause: `《公平竞争审查条例》
第九条 起草单位起草的政策措施，不得含有下列限制商品、要素自由流动的内容：
（五）在资质标准、监管执法等方面对外地经营者在本地投资经营设置歧视性要求。`,
            violationDetail: '规定企业在盐城市行政区域以外获得的业绩、荣誉不作为加分依据，对外地经营者实行差别待遇。',
        },
    ];

    let count = 0;
    for (const caseData of cases) {
        await prisma.case.create({
            data: {
                ...caseData,
                province: '江苏省',
                publishDate: reportData.publishDate,
                legalScope: '公平竞争审查',
                reportId: report.id
            }
        });
        console.log(`✅ 已添加案例 ${count + 1}:`, caseData.title);
        count++;
    }

    console.log(`\n处理完成，共添加 ${count} 个案例到 Report ID ${report.id}。`);
}

main()
    .catch((e) => {
        console.error(e);
        process.exit(1);
    })
    .finally(async () => {
        await prisma.$disconnect();
    });
