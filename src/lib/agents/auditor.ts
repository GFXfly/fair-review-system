import { callLLM } from '@/lib/llm';
import { searchSimilarCases, searchSimilarRegulations } from '@/lib/rag';
import { TextChunker } from '@/lib/text-utils';
import { APP_CONFIG } from '@/lib/config';

export interface AuditIssue {
    id: string;
    risk_level: 'High' | 'Medium' | 'Low';
    description: string;
    location: string; // Quote from the text
    suggestion: string;
    reference?: string; // Reference to similar case or regulation
    violated_law: string; // Specific article, e.g., "ã€Šå…¬å¹³ç«äº‰å®¡æŸ¥æ¡ä¾‹ã€‹ç¬¬åæ¡ç¬¬ä¸€æ¬¾"

    // Optional debate fields
    defense?: string;
    rulingReason?: string;
    confidence?: number;
}

/**
 * ğŸ”¥ æ–°å¢ï¼šé£é™©ç‰‡æ®µæå–å‡½æ•°
 * ç”¨äºåœ¨æ­£å¼å®¡æŸ¥å‰ï¼Œå¿«é€Ÿè¯†åˆ«æ–‡æ¡£ä¸­å¯èƒ½æ¶‰åŠå…¬å¹³ç«äº‰é—®é¢˜çš„å…³é”®ç‰‡æ®µ
 * è¿™äº›ç‰‡æ®µå°†ç”¨äºç²¾å‡†æ£€ç´¢ç›¸ä¼¼æ¡ˆä¾‹
 */
async function extractRiskKeywords(text: string): Promise<string[]> {
    const truncatedText = text.substring(0, 8000); // ä½¿ç”¨å‰8000å­—è¿›è¡Œå¿«é€Ÿæ‰«æ

    const systemPrompt = `
ä½ æ˜¯ä¸€ä¸ªå…¬å¹³ç«äº‰å®¡æŸ¥ä¸“å®¶ã€‚è¯·å¿«é€Ÿæ‰«æä»¥ä¸‹æ”¿åºœæ–‡ä»¶ï¼Œæå–å‡ºæ‰€æœ‰å¯èƒ½æ¶‰åŠå…¬å¹³ç«äº‰é—®é¢˜çš„"é£é™©å…³é”®ç‰‡æ®µ"ã€‚

**æå–è§„åˆ™**ï¼š
1. æ¯ä¸ªç‰‡æ®µåº”è¯¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ”¿ç­–æè¿°ï¼ˆ20-100å­—ï¼‰
2. ç›´æ¥å¤åˆ¶åŸæ–‡ä¸­çš„ç›¸å…³å¥å­ï¼Œä¸è¦æ”¹å†™
3. æœ€å¤šæå–8ä¸ªæœ€å…³é”®çš„ç‰‡æ®µ

**é‡ç‚¹å…³æ³¨ä»¥ä¸‹å››å¤§ç»´åº¦çš„é£é™©ç±»å‹**ï¼š

ã€ç»´åº¦ä¸€ï¼šå¸‚åœºå‡†å…¥å’Œé€€å‡ºã€‘
- åœ°åŸŸé™åˆ¶ï¼š"æœ¬åœ°ä¼ä¸š"ã€"å¤–åœ°ä¼ä¸šä¸å¾—å‚ä¸"ã€"æœ¬å¸‚æ³¨å†Œ"ã€"åœ¨æœ¬åœ°è®¾ç«‹åˆ†æ”¯æœºæ„"
- æ‰€æœ‰åˆ¶æ­§è§†ï¼š"å›½æœ‰ä¼ä¸šä¼˜å…ˆ"ã€"æ°‘è¥ä¼ä¸š"ã€"å›½æœ‰æ§è‚¡"ã€"å¤–èµ„ä¼ä¸š"
- è§„æ¨¡/ä¸šç»©é™åˆ¶ï¼š"è§„æ¨¡ä»¥ä¸Šä¼ä¸š"ã€"å¹´äº§å€¼XXä¸‡ä»¥ä¸Š"ã€"çº³ç¨é¢è¾¾åˆ°"ã€"è¥ä¸šæ”¶å…¥ä¸ä½äº"
- èµ„è´¨é™åˆ¶ï¼š"é¡»å…·å¤‡XXèµ„è´¨"ã€"è¿‘ä¸‰å¹´ä¸šç»©"ã€"ä¸­æ ‡ç»éªŒ"ã€"è¡Œä¸šæ’åå‰XX"

ã€ç»´åº¦äºŒï¼šå•†å“å’Œè¦ç´ è‡ªç”±æµåŠ¨ã€‘
- æŒ‡å®šå“ç‰Œ/äº§åœ°ï¼š"é¡»ä½¿ç”¨XXå“ç‰Œ"ã€"æœ¬åœ°äº§å“ä¼˜å…ˆ"ã€"å›½äº§ä¼˜å…ˆ"ã€"è¿›å£äº§å“"
- æŒ‡å®šä¾›åº”å•†ï¼š"é¡»ä»XXå•ä½é‡‡è´­"ã€"æŒ‡å®šæœåŠ¡å•†"ã€"å”¯ä¸€ä¾›åº”å•†"
- æŠ€æœ¯å£å’ï¼š"é¡»é‡‡ç”¨XXæŠ€æœ¯æ ‡å‡†"ã€"æŒæœ‰XXä¸“åˆ©"

ã€ç»´åº¦ä¸‰ï¼šå½±å“ç”Ÿäº§ç»è¥æˆæœ¬ã€‘
- è´¢æ”¿è¡¥è´´/å¥–åŠ±ï¼š"ç»™äºˆå¥–åŠ±"ã€"è´¢æ”¿è¡¥è´´"ã€"æ‰¶æŒèµ„é‡‘"ã€"äº§ä¸šå¼•å¯¼èµ„é‡‘"
- ç¨æ”¶ä¼˜æƒ ï¼š"ç¨æ”¶è¿”è¿˜"ã€"ç¨æ”¶å‡å…"ã€"ç¨æ”¶ä¼˜æƒ "
- åœŸåœ°/èµ„æºä¼˜æƒ ï¼š"ä¼˜æƒ ä¾›åœ°"ã€"ç”¨åœ°æŒ‡æ ‡"ã€"æ°´ç”µæ°”ä¼˜æƒ "
- æ”¶è´¹/ä¿è¯é‡‘ï¼š"æ”¶å–ä¿è¯é‡‘"ã€"æŠ•æ ‡ä¿è¯é‡‘"ã€"å±¥çº¦ä¿è¯é‡‘æ¯”ä¾‹"

ã€ç»´åº¦å››ï¼šå½±å“ç”Ÿäº§ç»è¥è¡Œä¸ºã€‘
- é™åˆ¶å®šæ ‡æƒï¼š"ä¸å¾—è‡ªè¡Œé€‰æ‹©ä¸­æ ‡äºº"ã€"é¡»ç”±XXç¡®å®š"ã€"æ‘‡å·ç¡®å®š"ã€"æŠ“é˜„"
- å¼ºåˆ¶äº¤æ˜“ï¼š"å¿…é¡»è´­ä¹°"ã€"å¼ºåˆ¶ä½¿ç”¨"ã€"ç»Ÿä¸€é‡‡è´­"
- é™åˆ¶è”åˆä½“ï¼š"è”åˆä½“æˆå‘˜é¡»æ»¡è¶³"ã€"ç‰µå¤´å•ä½é¡»ä¸ºæœ¬åœ°ä¼ä¸š"

**è¾“å‡ºæ ¼å¼**ï¼š
è¿”å›JSONæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªé£é™©ç‰‡æ®µå­—ç¬¦ä¸²ã€‚
ç¤ºä¾‹ï¼š["è§„æ¨¡ä»¥ä¸Šåˆ¶é€ ä¸šä¼ä¸šç»™äºˆ0.3å…ƒ/åº¦çš„è¡¥è´´", "æœ¬å¸‚æ³¨å†Œä¼ä¸šä¼˜å…ˆ", "è”åˆä½“ç‰µå¤´å•ä½é¡»ä¸ºæœ¬åœ°ä¼ä¸š"]

å¦‚æœæ–‡æ¡£æ²¡æœ‰æ˜æ˜¾çš„é£é™©ç‰‡æ®µï¼Œè¿”å›ç©ºæ•°ç»„ï¼š[]
`;

    const userPrompt = `è¯·åˆ†æä»¥ä¸‹æ–‡ä»¶å†…å®¹ï¼Œæå–é£é™©å…³é”®ç‰‡æ®µï¼š\n\n${truncatedText}`;

    try {
        const result = await callLLM(systemPrompt, userPrompt, true, 'deepseek-chat');
        if (!result) return [];

        const keywords = JSON.parse(result);
        if (Array.isArray(keywords)) {
            console.log(`[RAG] ğŸ¯ æå–åˆ° ${keywords.length} ä¸ªé£é™©å…³é”®ç‰‡æ®µ`);
            keywords.forEach((k, i) => console.log(`  ${i + 1}. ${k.substring(0, 50)}...`));
            return keywords.slice(0, 8); // æœ€å¤š8ä¸ª
        }
        return [];
    } catch (e) {
        console.error('[RAG] é£é™©ç‰‡æ®µæå–å¤±è´¥:', e);
        return [];
    }
}

export async function runAuditor(category: string, text: string, guidance: string = ""): Promise<AuditIssue[]> {
    console.log('Running Auditor on category:', category);

    // ==========================================
    // ğŸ”¥ ä¼˜åŒ–ï¼šå…ˆæå–é£é™©ç‰‡æ®µï¼Œå†ç²¾å‡†æ£€ç´¢
    // ==========================================

    // ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°
    const { rag } = APP_CONFIG;

    // ğŸ”¥ ç¬¬ä¸€æ­¥ï¼šæå–é£é™©å…³é”®ç‰‡æ®µ
    console.log(`[RAG] ğŸ” ç¬¬ä¸€æ­¥ï¼šæå–é£é™©å…³é”®ç‰‡æ®µ...`);
    const riskKeywords = await extractRiskKeywords(text);

    // ğŸ”¥ ç¬¬äºŒæ­¥ï¼šé’ˆå¯¹æ¯ä¸ªé£é™©ç‰‡æ®µè¿›è¡Œç²¾å‡†æ£€ç´¢
    console.log(`[RAG] ğŸ” ç¬¬äºŒæ­¥ï¼šé’ˆå¯¹ ${riskKeywords.length} ä¸ªé£é™©ç‰‡æ®µè¿›è¡Œç²¾å‡†æ£€ç´¢...`);

    const allCasesMap = new Map<number, typeof allCases[0]>(); // ç”¨äºå»é‡
    let allCases: Awaited<ReturnType<typeof searchSimilarCases>> = [];

    // å¯¹æ¯ä¸ªé£é™©ç‰‡æ®µè¿›è¡Œæ£€ç´¢
    for (const keyword of riskKeywords) {
        const cases = await searchSimilarCases(keyword, 5, 0.45); // è¿›ä¸€æ­¥é™ä½é˜ˆå€¼åˆ°45%ï¼Œå¢åŠ å¬å›ï¼ˆAIä¼šåœ¨promptä¸­äºŒæ¬¡ç­›é€‰ï¼‰
        cases.forEach(c => {
            // åªä¿ç•™ç›¸ä¼¼åº¦æœ€é«˜çš„ç‰ˆæœ¬
            const existing = allCasesMap.get(c.id);
            if (!existing || c.similarity > existing.similarity) {
                allCasesMap.set(c.id, c);
            }
        });
        console.log(`  - "${keyword.substring(0, 30)}..." â†’ æ‰¾åˆ° ${cases.length} ä¸ªæ¡ˆä¾‹`);
    }

    // å¦‚æœé£é™©ç‰‡æ®µæ£€ç´¢ç»“æœä¸è¶³ï¼Œç”¨å…¨æ–‡æ‘˜è¦å…œåº•
    if (allCasesMap.size < 3) {
        console.log(`[RAG] âš ï¸ é£é™©ç‰‡æ®µæ£€ç´¢ç»“æœä¸è¶³ï¼Œä½¿ç”¨å…¨æ–‡æ‘˜è¦å…œåº•...`);
        const summaryForRAG = TextChunker.truncate(text, rag.ragInputLength);
        const fallbackCases = await searchSimilarCases(summaryForRAG, rag.maxCasesPerQuery, 0.50);
        fallbackCases.forEach(c => {
            if (!allCasesMap.has(c.id)) {
                allCasesMap.set(c.id, c);
            }
        });
    }

    // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰ç›¸ä¼¼åº¦æ’åº
    allCases = Array.from(allCasesMap.values()).sort((a, b) => b.similarity - a.similarity);

    // ğŸ”¥ ç¬¬ä¸‰æ­¥ï¼šæ£€ç´¢æ³•è§„ï¼ˆä»ç”¨å…¨æ–‡æ‘˜è¦ï¼Œæ³•è§„æ£€ç´¢ä¸å¤ªéœ€è¦ç²¾å‡†ï¼‰
    const summaryForRegs = TextChunker.truncate(text, rag.ragInputLength);
    const allRegs = await searchSimilarRegulations(summaryForRegs, rag.maxRegulationsPerQuery, rag.regulationSimilarityThreshold);

    // æœ€ç»ˆå–é…ç½®æ•°é‡çš„æ¡ˆä¾‹å’Œæ³•è§„
    const uniqueCases = allCases.slice(0, rag.finalCasesCount + 3); // å¤šç»™å‡ ä¸ªæ¡ˆä¾‹ï¼Œæé«˜å‘½ä¸­ç‡
    const uniqueRegs = allRegs.slice(0, rag.finalRegulationsCount);

    // ==========================================
    // ğŸ”¥ æ£€ç´¢è´¨é‡æ—¥å¿—
    // ==========================================

    console.log(`[RAG] æ£€ç´¢ç»“æœç»Ÿè®¡ï¼š`);
    console.log(`  - æ¡ˆä¾‹æ•°ï¼š${uniqueCases.length}/${rag.finalCasesCount}`);
    if (uniqueCases.length > 0) {
        const similarities = uniqueCases.map(c => c.similarity);
        console.log(`  - æ¡ˆä¾‹ç›¸ä¼¼åº¦èŒƒå›´ï¼š${(Math.min(...similarities) * 100).toFixed(1)}% ~ ${(Math.max(...similarities) * 100).toFixed(1)}%`);
    }
    console.log(`  - æ³•è§„æ•°ï¼š${uniqueRegs.length}/${rag.finalRegulationsCount}`);
    if (uniqueRegs.length > 0) {
        const similarities = uniqueRegs.map(r => r.similarity);
        console.log(`  - æ³•è§„ç›¸ä¼¼åº¦èŒƒå›´ï¼š${(Math.min(...similarities) * 100).toFixed(1)}% ~ ${(Math.max(...similarities) * 100).toFixed(1)}%`);
    }

    // è­¦å‘Šï¼šé«˜è´¨é‡æ¡ˆä¾‹ä¸è¶³
    const highQualityCases = uniqueCases.filter(c => c.similarity > rag.highQualityThreshold);
    if (highQualityCases.length < rag.minHighQualityCases) {
        console.warn(`[RAG] âš ï¸  é«˜ç›¸å…³æ€§æ¡ˆä¾‹ä¸è¶³ï¼ˆ>75%ï¼š${highQualityCases.length}ä¸ªï¼‰ï¼Œå¯èƒ½å½±å“åˆ¤æ–­å‡†ç¡®æ€§`);
    }

    // ==========================================
    // ğŸ”¥ æ„å»ºRAGä¸Šä¸‹æ–‡ï¼ˆæ ‡æ³¨ç›¸ä¼¼åº¦ï¼‰
    // ==========================================

    let ragContext = "";

    if (uniqueCases.length > 0) {
        ragContext += "\nã€å¯å¼•ç”¨çš„ç›¸ä¼¼æ¡ˆä¾‹/æƒå¨è®¤å®šï¼ˆç”¨äº reference å­—æ®µï¼‰ã€‘ï¼š\n";
        ragContext += "è¯´æ˜ï¼šä»¥ä¸‹æ¡ˆä¾‹å¯ä½œä¸ºä½è¯ææ–™å¼•ç”¨ã€‚è‹¥ç›¸ä¼¼åº¦é«˜ä¸”è¿è§„æœ¬è´¨ç›¸åŒï¼Œè¯·åœ¨referenceå­—æ®µä¸­å¼•ç”¨æ¡ˆä¾‹åŸæ–‡ã€‚\n\n";

        uniqueCases.forEach((c, idx) => {
            const similarityPercent = (c.similarity * 100).toFixed(1);
            const similarityLabel = c.similarity >= 0.75 ? 'ã€é«˜åº¦ç›¸ä¼¼ã€‘' :
                c.similarity >= 0.60 ? 'ã€ä¸­åº¦ç›¸ä¼¼ã€‘' : 'ã€å‚è€ƒä»·å€¼ä½ã€‘';

            ragContext += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            ragContext += `æ¡ˆä¾‹${idx + 1} ${similarityLabel}ï¼ˆç›¸ä¼¼åº¦ï¼š${similarityPercent}%ï¼‰\n`;
            ragContext += `æ ‡é¢˜ï¼šã€${c.violationType}ã€‘${c.title}\n`;

            // å±•ç¤ºæ›´å®Œæ•´çš„æ¡ˆä¾‹åŸæ–‡ï¼ˆ4000å­—ï¼‰
            const fullContent = c.content || '';
            ragContext += `ã€æ¡ˆä¾‹åŸæ–‡ã€‘ï¼š\n${fullContent.substring(0, 4000)}${fullContent.length > 4000 ? '...(çœç•¥)' : ''}\n`;

            // è¿è§„è¦ç‚¹
            if (c.violationDetail) {
                ragContext += `âš ï¸ è¿è§„è¦ç‚¹ï¼š${c.violationDetail}\n`;
            }

            // å¤„ç†ç»“æœ
            if (c.result) {
                ragContext += `å¤„ç†ç»“æœï¼š${c.result}\n`;
            }

            ragContext += `\n`;
        });
    } else {
        // å¦‚æœæ²¡æœ‰æ£€ç´¢åˆ°æ¡ˆä¾‹ï¼Œæç¤ºAI
        ragContext += "\nâš ï¸ æœªæ£€ç´¢åˆ°ç›¸å…³å†å²æ¡ˆä¾‹ï¼ˆç›¸ä¼¼åº¦<45%ï¼‰ï¼Œè¯·ä»…ä¾æ®æ³•è§„è¿›è¡Œç‹¬ç«‹åˆ¤æ–­ã€‚\n\n";
    }

    if (uniqueRegs.length > 0) {
        ragContext += "\nç›¸å…³æ³•å¾‹æ³•è§„ä¾æ®ï¼ˆè¯·åœ¨ violated_law å­—æ®µä¸­å®Œæ•´å¼•ç”¨å…·ä½“æ¡æ¬¾ï¼‰ï¼š\n";
        uniqueRegs.forEach((r, idx) => {
            const similarityPercent = (r.similarity * 100).toFixed(1);
            ragContext += `æ³•è§„${idx + 1}ï¼ˆç›¸ä¼¼åº¦ï¼š${similarityPercent}%ï¼‰ï¼šã€Š${r.title}ã€‹\n`;
            ragContext += `   å†…å®¹ï¼š${r.content ? r.content.substring(0, 1000) : 'æš‚æ— '}...\n\n`;
        });
    }

    const systemPrompt = `
    ä½ æ˜¯ä¸€ä¸ªèµ„æ·±çš„"å…¬å¹³ç«äº‰å®¡æŸ¥"å®¡è®¡å‘˜ï¼ˆAuditorï¼‰ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ã€Šå…¬å¹³ç«äº‰å®¡æŸ¥æ¡ä¾‹ã€‹åŠç›¸å…³æ³•å¾‹æ³•è§„ï¼Œå®¡æŸ¥æ”¿åºœæ–‡ä»¶æ˜¯å¦å­˜åœ¨æ’é™¤ã€é™åˆ¶ç«äº‰çš„å†…å®¹ã€‚

    ã€æ ¸å¿ƒæŒ‡ä»¤ - æ³•è§„å¼•ç”¨è§„åˆ™ã€‘ï¼š
    
    å½“å‰å®¡æŸ¥ç±»åˆ«æ˜¯ï¼š${category}
    
    ${category === 'BIDDING' ? `
    ã€æ‹›æ ‡æ–‡ä»¶å®¡æŸ¥æ ‡å‡†ã€‘
    1. **ä¸»è¦ä¾æ®**ï¼šã€Šæµ™æ±Ÿçœæ‹›æ ‡æŠ•æ ‡é¢†åŸŸå…¬å¹³ç«äº‰å®¡æŸ¥ç»†åˆ™ã€‹ï¼ˆ21æ¡ç¦æ­¢æ€§è§„å®šï¼‰
    2. **violated_lawå­—æ®µ**ï¼šä¼˜å…ˆå¼•ç”¨æµ™æ±Ÿç»†åˆ™çš„å…·ä½“æ¡æ¬¾
       æ ¼å¼ç¤ºä¾‹ï¼š"ã€Šæµ™æ±Ÿçœæ‹›æ ‡æŠ•æ ‡é¢†åŸŸå…¬å¹³ç«äº‰å®¡æŸ¥ç»†åˆ™ã€‹ç¬¬ä¸‰æ¡ç¬¬ï¼ˆå…«ï¼‰é¡¹ç¬¬5ç‚¹ï¼šä¸å¾—å°†ç»è¥è€…å–å¾—ä¸šç»©...ä½œä¸ºæŠ•æ ‡æ¡ä»¶ã€‚"
    3. **åˆ¤å®šæ ‡å‡†**ï¼šæ‹›æ ‡æ–‡ä»¶ä¸­åŸºäºåœ°åŸŸã€æ‰€æœ‰åˆ¶ã€è§„æ¨¡ã€ä¸šç»©çš„ä¸åˆç†é™åˆ¶ï¼Œè§†ä¸º**æ˜ç¡®è¿è§„**
    ` : `
    ã€æ”¿ç­–æ–‡ä»¶/æ”¿åºœåè®®å®¡æŸ¥æ ‡å‡†ã€‘
    1. **ä¸»è¦ä¾æ®**ï¼šã€Šå…¬å¹³ç«äº‰å®¡æŸ¥æ¡ä¾‹å®æ–½åŠæ³•ã€‹ï¼ˆç¬¬9-24æ¡å®¡æŸ¥æ ‡å‡†ï¼‰
    2. **violated_lawå­—æ®µ**ï¼šå¼•ç”¨å®æ–½åŠæ³•çš„å…·ä½“æ¡æ¬¾
       æ ¼å¼ç¤ºä¾‹ï¼š"ã€Šå…¬å¹³ç«äº‰å®¡æŸ¥æ¡ä¾‹å®æ–½åŠæ³•ã€‹ç¬¬åäº”æ¡ç¬¬ä¸‰æ¬¾ï¼šä¸å¾—å°†ç»è¥è€…å–å¾—ä¸šç»©å’Œå¥–é¡¹è£èª‰çš„åŒºåŸŸ...ä½œä¸ºæŠ•æ ‡æ¡ä»¶ã€‚"
    3. **å®¡æŸ¥èŒƒå›´**ï¼š
       - ç¬¬9-12æ¡ï¼šé™åˆ¶å¸‚åœºå‡†å…¥å’Œé€€å‡º
       - ç¬¬13-17æ¡ï¼šé™åˆ¶å•†å“ã€è¦ç´ è‡ªç”±æµåŠ¨
       - ç¬¬18-20æ¡ï¼šå½±å“ç”Ÿäº§ç»è¥æˆæœ¬
       - ç¬¬21-23æ¡ï¼šå½±å“ç”Ÿäº§ç»è¥è¡Œä¸º
    `}

    å®¡æŸ¥é‡ç‚¹ï¼ˆç‰¹åˆ«é’ˆå¯¹å·¥ç¨‹å»ºè®¾å’Œæ‹›æŠ•æ ‡ï¼‰ï¼š
    1. **å¸‚åœºå‡†å…¥å’Œé€€å‡º**:
       - æ˜¯å¦è¦æ±‚åœ¨æœ¬åœ°åŒºè®¾ç«‹åˆ†æ”¯æœºæ„ã€ç¼´çº³ç¨æ”¶ç¤¾ä¿ï¼Ÿ
       - æ˜¯å¦å°†ç‰¹å®šè¡Œæ”¿åŒºåŸŸçš„ä¸šç»©ã€å¥–é¡¹ä½œä¸ºåŠ åˆ†æˆ–ä¸­æ ‡æ¡ä»¶ï¼Ÿ
       - æ˜¯å¦è®¾ç½®è¿‡é«˜çš„æ³¨å†Œèµ„æœ¬ã€å‡€èµ„äº§ã€è¥æ”¶ç­‰è§„æ¨¡é—¨æ§›ï¼Ÿ
    2. **å•†å“å’Œè¦ç´ è‡ªç”±æµåŠ¨**:
       - æ˜¯å¦é™å®šç‰¹å®šçš„å“ç‰Œã€ä¸“åˆ©ã€ä¾›åº”å•†æˆ–äº§åœ°ï¼Ÿ
       - æ˜¯å¦è¦æ±‚"ä¼˜å…ˆé‡‡è´­æœ¬å›½/æœ¬åœ°äº§å“"è€Œæ— æ³•è§„ä¾æ®ï¼Ÿ
       - æ˜¯å¦å¯¹è”åˆä½“æˆå‘˜çš„æ³¨å†Œåœ°ã€æ‰€æœ‰åˆ¶è®¾ç½®å·®å¼‚æ€§å¾—åˆ†ï¼Ÿ
       - æ˜¯å¦è¦æ±‚å¿…é¡»æä¾›åŸä»¶è€Œéç”µå­è¯ç…§ï¼Ÿ
    3. **å½±å“ç”Ÿäº§ç»è¥æˆæœ¬**: æ˜¯å¦å¼ºåˆ¶è¦æ±‚æä¾›ç‰¹å®šæœºæ„çš„ä¿å‡½ï¼Ÿæ˜¯å¦è¿æ³•æ”¶å–ä¿è¯é‡‘ï¼Ÿ
    4. **å®šæ ‡å’Œå®šæ ‡æƒ**: æ˜¯å¦é™åˆ¶æ‹›æ ‡äººçš„å®šæ ‡è‡ªä¸»æƒï¼Ÿæ˜¯å¦é‡‡ç”¨æ‘‡å·ã€æŠ“é˜„ç­‰æ–¹å¼ç¡®å®šä¸­æ ‡äººï¼Ÿ

    // ==========================================
    // ğŸ”¥ ç‹¬ç«‹è¾“å‡ºè§„åˆ™ã€æå…¶é‡è¦ã€‘
    // ==========================================

    ã€å¼ºåˆ¶è§„åˆ™ã€‘ä¸€ä¸ªé£é™©ç‚¹å¯¹åº”ä¸€ä¸ªæ”¿ç­–æ¡æ¬¾ï¼š

    âŒ ç¦æ­¢åˆå¹¶ï¼šå¦‚æœæ–‡ä»¶ä¸­æœ‰"æ”¿ç­–1ã€æ”¿ç­–2ã€æ”¿ç­–3"ä¸‰ä¸ªç‹¬ç«‹çš„è¿è§„æ¡æ¬¾ï¼Œå¿…é¡»è¾“å‡º3ä¸ªç‹¬ç«‹çš„riskå¯¹è±¡ï¼Œä¸å¾—åˆå¹¶ã€‚

    âœ… æ­£ç¡®åšæ³•ï¼š
    - æ¯ä¸ªriskçš„locationå­—æ®µåªèƒ½åŒ…å«ä¸€ä¸ªæ”¿ç­–æ¡æ¬¾çš„å®Œæ•´åŸæ–‡ï¼ˆ30-200å­—ï¼‰
    - å³ä½¿è¿è§„ç±»å‹ç›¸åŒï¼ˆå¦‚éƒ½æ˜¯"è§„æ¨¡é™åˆ¶"ï¼‰ï¼Œä¹Ÿå¿…é¡»ç‹¬ç«‹è¾“å‡º
    - æ¯ä¸ªriskéƒ½è¦æœ‰ç‹¬ç«‹çš„descriptionã€suggestionã€reference

    ã€é”™è¯¯ç¤ºä¾‹ã€‘âŒ åˆå¹¶å¤šä¸ªæ”¿ç­–ï¼š
    {
      "location": "æ”¿ç­–1ç»†åˆ™ï¼šè§„æ¨¡ä»¥ä¸Šåˆ¶é€ ä¸šä¼ä¸šä¾›ç”µ...ï¼›æ”¿ç­–2ç»†åˆ™ï¼šè§„æ¨¡ä»¥ä¸Šå·¥ä¸šä¼ä¸š2026å¹´...ï¼›æ”¿ç­–5ç»†åˆ™ï¼š1-2æœˆè§„æ¨¡åŒæ¯”å¢é•¿..."
    }

    ã€æ­£ç¡®ç¤ºä¾‹ã€‘âœ… ç‹¬ç«‹è¾“å‡ºï¼š
    [
      {
        "id": "risk_1",
        "location": "æ”¿ç­–1ç»†åˆ™ï¼šè§„æ¨¡ä»¥ä¸Šåˆ¶é€ ä¸šä¼ä¸šä¾›ç”µç”µå‹ç­‰çº§10åƒä¼åŠä»¥ä¸Šä¸”æ˜¥èŠ‚å‡æœŸæœŸé—´"ä¸åœäº§"...ç»™äºˆç”¨ç”µè¡¥è´´",
        "description": "ã€è§„æ¨¡/ä¸šç»©é™åˆ¶ + è´¢æ”¿è¡¥è´´ã€‘è¯¥æ¡æ¬¾å°†ç”¨ç”µè¡¥è´´é™å®šåœ¨'è§„æ¨¡ä»¥ä¸Šåˆ¶é€ ä¸šä¼ä¸š'ï¼Œæ’é™¤äº†è§„æ¨¡ä»¥ä¸‹ä¼ä¸š..."
      },
      {
        "id": "risk_2",
        "location": "æ”¿ç­–2ç»†åˆ™ï¼šè§„æ¨¡ä»¥ä¸Šå·¥ä¸šä¼ä¸š2026å¹´ä¸€å­£åº¦äº§å€¼è¾ƒ2025å¹´ä¸€å­£åº¦äº§å€¼æ¯å¢åŠ 1000ä¸‡å…ƒå¥–åŠ±2ä¸‡å…ƒ",
        "description": "ã€è§„æ¨¡/ä¸šç»©é™åˆ¶ + è´¢æ”¿è¡¥è´´ã€‘è¯¥æ¡æ¬¾å°†äº§å€¼å¢é•¿å¥–åŠ±é™å®šåœ¨'è§„æ¨¡ä»¥ä¸Šå·¥ä¸šä¼ä¸š'ï¼Œæ’é™¤äº†è§„æ¨¡ä»¥ä¸‹ä¼ä¸š..."
      },
      {
        "id": "risk_3",
        "location": "æ”¿ç­–5ç»†åˆ™ï¼š1-2æœˆè§„æ¨¡åŒæ¯”å¢é•¿çš„è¥åˆ©æ€§æœåŠ¡ä¸šä¼ä¸šï¼Œæ¯æ–°å¢1000ä¸‡å…ƒå¥–åŠ±2ä¸‡å…ƒ",
        "description": "ã€è§„æ¨¡/ä¸šç»©é™åˆ¶ + è´¢æ”¿è¡¥è´´ã€‘è¯¥æ¡æ¬¾å°†å¥–åŠ±é™å®šåœ¨'è§„æ¨¡åŒæ¯”å¢é•¿çš„è¥åˆ©æ€§æœåŠ¡ä¸šä¼ä¸š'ï¼Œæ’é™¤äº†å…¶ä»–ä¼ä¸š..."
      }
    ]

    ç‹¬ç«‹è¾“å‡ºçš„å¥½å¤„ï¼š
    1. ç”¨æˆ·å¯ä»¥é€æ¡å®šä½åŸæ–‡ï¼Œå¿«é€ŸæŸ¥æ‰¾
    2. æ¯ä¸ªæ”¿ç­–éƒ½æœ‰ç‹¬ç«‹çš„ä¿®æ”¹å»ºè®®ï¼Œä¾¿äºæ•´æ”¹
    3. å¯ä»¥åˆ†åˆ«æ ‡è®°æ•´æ”¹è¿›åº¦ï¼ˆæ”¿ç­–1å·²æ”¹ï¼Œæ”¿ç­–2å¾…æ”¹ï¼‰

    å‚è€ƒçŸ¥è¯†åº“ä¿¡æ¯ï¼š
    ${guidance}

    ${ragContext}

    // ==========================================
    // ğŸ”¥ Few-shotç¤ºä¾‹æ•™å­¦
    // ==========================================

    **ç¤ºä¾‹æ•™å­¦**ï¼ˆè¯·ä¸¥æ ¼å‚ç…§ä»¥ä¸‹ç¤ºä¾‹çš„åˆ¤å®šé€»è¾‘ï¼‰ï¼š

    ã€ç¤ºä¾‹1ï¼šæ˜ç¡®è¿è§„ - Highé£é™©ã€‘
    åŸæ–‡å¼•ç”¨ï¼š"æŠ•æ ‡äººé¡»ä¸ºæœ¬å¸‚æ³¨å†Œä¼ä¸šï¼Œå¤–åœ°ä¼ä¸šä¸å¾—å‚ä¸æœ¬é¡¹ç›®æŠ•æ ‡ã€‚"

    AIåˆ¤å®šè¿‡ç¨‹ï¼š
    1. è¯†åˆ«è¿è§„ç±»å‹ï¼šåœ°åŸŸæ€§é™åˆ¶ï¼ˆç±»å‹1ï¼‰
    2. åˆ¤å®šæ ¸å¿ƒè¦ç´ ï¼š
       - é™åˆ¶å¯¹è±¡ï¼šå¤–åœ°ä¼ä¸šï¼ˆæ˜ç¡®æ’æ–¥ï¼‰
       - é™åˆ¶æ‰‹æ®µï¼š"ä¸å¾—å‚ä¸"ï¼ˆå¼ºåˆ¶æ€§ç¦æ­¢ï¼‰
       - é™åˆ¶èŒƒå›´ï¼šæ‰€æœ‰å¤–åœ°ä¼ä¸šï¼ˆæ— ä¾‹å¤–ï¼‰
    3. æ£€ç´¢æ¡ˆä¾‹ï¼šä»ä¸Šæ–¹ã€å¯å¼•ç”¨çš„ç›¸ä¼¼æ¡ˆä¾‹ã€‘ä¸­æŸ¥æ‰¾ç›¸ä¼¼åº¦>70%çš„æ¡ˆä¾‹
    4. é£é™©ç­‰çº§ï¼šHighï¼ˆæ˜ç¡®è¿åã€Šæ¡ä¾‹ã€‹ç¬¬åæ¡ï¼‰

    è¾“å‡ºJSONï¼š
    {
        "id": "risk_1",
        "risk_level": "High",
        "description": "ã€åœ°åŸŸæ€§é™åˆ¶ã€‘æ–‡ä»¶æ˜ç¡®è¦æ±‚æŠ•æ ‡äººå¿…é¡»ä¸ºæœ¬å¸‚æ³¨å†Œä¼ä¸šï¼Œç›´æ¥æ’æ–¥å¤–åœ°ä¼ä¸šå‚ä¸æŠ•æ ‡ï¼Œè¿åäº†ã€Šå…¬å¹³ç«äº‰å®¡æŸ¥æ¡ä¾‹ã€‹ç¬¬åæ¡å…³äº'ä¸å¾—è®¾ç½®ä¸åˆç†çš„æ¡ä»¶æ’æ–¥æˆ–è€…é™åˆ¶å¤–åœ°ç»è¥è€…å‚åŠ æœ¬åœ°æ‹›æ ‡æŠ•æ ‡æ´»åŠ¨'çš„è§„å®šã€‚",
        "violated_law": "ã€Šå…¬å¹³ç«äº‰å®¡æŸ¥æ¡ä¾‹å®æ–½åŠæ³•ã€‹ç¬¬åäº”æ¡ç¬¬ä¸€æ¬¾ï¼šç¦æ­¢å¤–åœ°ç»è¥è€…å‚ä¸æœ¬åœ°æ”¿åºœé‡‡è´­ã€æ‹›æ ‡æŠ•æ ‡æ´»åŠ¨ã€‚",
        "location": "æŠ•æ ‡äººé¡»ä¸ºæœ¬å¸‚æ³¨å†Œä¼ä¸šï¼Œå¤–åœ°ä¼ä¸šä¸å¾—å‚ä¸æœ¬é¡¹ç›®æŠ•æ ‡",
        "suggestion": "å»ºè®®åˆ é™¤'æœ¬å¸‚æ³¨å†Œä¼ä¸š'çš„è¦æ±‚ï¼Œæ”¹ä¸º'ä¾æ³•æ³¨å†Œçš„ä¼ä¸š'ï¼Œä¸é™åˆ¶æ³¨å†Œåœ°åŸŸã€‚",
        "reference": ""
    }

    ã€ç¤ºä¾‹2ï¼šç°è‰²åœ°å¸¦ - Mediumé£é™©ã€‘
    åŸæ–‡å¼•ç”¨ï¼š"ä¼˜å…ˆæ”¯æŒå¹´çº³ç¨é¢1000ä¸‡å…ƒä»¥ä¸Šçš„ä¼ä¸šç”³æŠ¥é¡¹ç›®ã€‚"

    è¾“å‡ºJSONï¼š
    {
        "id": "risk_2",
        "risk_level": "Medium",
        "description": "ã€è§„æ¨¡/ä¸šç»©é™åˆ¶ + è´¢æ”¿ä¼˜æƒ ã€‘æ–‡ä»¶è®¾ç½®å¹´çº³ç¨é¢1000ä¸‡å…ƒçš„é—¨æ§›ï¼Œå¹¶ç»™äºˆ'ä¼˜å…ˆæ”¯æŒ'ï¼Œè¿™å±äºé€‰æ‹©æ€§æ”¯æŒæ”¿ç­–ï¼Œå¯èƒ½å¯¹ä¸­å°ä¼ä¸šæ„æˆä¸å…¬å¹³ç«äº‰ã€‚",
        "violated_law": "ã€Šå…¬å¹³ç«äº‰å®¡æŸ¥æ¡ä¾‹ã€‹ç¬¬åäºŒæ¡ï¼šé™¤æ³•å¾‹ã€è¡Œæ”¿æ³•è§„å¦æœ‰è§„å®šå¤–ï¼Œä¸å¾—ç»™äºˆç‰¹å®šç»è¥è€…ä¼˜æƒ æ”¿ç­–ã€‚",
        "location": "ä¼˜å…ˆæ”¯æŒå¹´çº³ç¨é¢1000ä¸‡å…ƒä»¥ä¸Šçš„ä¼ä¸šç”³æŠ¥é¡¹ç›®",
        "suggestion": "å»ºè®®å–æ¶ˆçº³ç¨é¢é—¨æ§›ï¼Œæˆ–è¯´æ˜è¯¥æ”¿ç­–çš„æ³•å¾‹ä¾æ®ã€‚",
        "reference": ""
    }

    ã€ç¤ºä¾‹3ï¼šåˆç†è¦æ±‚ - ä¸æ„æˆé£é™©ã€‘
    åŸæ–‡å¼•ç”¨ï¼š"æŠ•æ ‡äººé¡»å…·å¤‡å»ºç­‘å·¥ç¨‹æ–½å·¥æ€»æ‰¿åŒ…äºŒçº§åŠä»¥ä¸Šèµ„è´¨ï¼Œä¸”è¿‘ä¸‰å¹´æ— é‡å¤§å®‰å…¨äº‹æ•…ã€‚"

    AIåˆ¤å®šè¿‡ç¨‹ï¼š
    1. åˆæ­¥æ€€ç–‘ï¼šèµ„è´¨/è£èª‰é™åˆ¶ï¼ˆç±»å‹4ï¼‰ï¼Ÿ
    2. æ·±å…¥åˆ†æï¼š
       - èµ„è´¨è¦æ±‚ï¼šè¡Œä¸šå‡†å…¥å¿…è¦æ¡ä»¶ï¼ˆã€Šå»ºç­‘æ³•ã€‹è§„å®šï¼‰
       - å®‰å…¨è®°å½•ï¼šåˆè§„ç®¡ç†éœ€è¦ï¼Œéæ­§è§†æ€§æ¡ä»¶
    3. ç»“è®ºï¼šä¸æ„æˆå…¬å¹³ç«äº‰é£é™©ï¼Œä¸è¾“å‡ºæ­¤é¡¹

    // ==========================================
    // ğŸ”¥ referenceå­—æ®µå¼•ç”¨è§„åˆ™ã€æå…¶é‡è¦ã€‘
    // ==========================================

    **æ¡ˆä¾‹å¼•ç”¨è§„åˆ™ï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰**ï¼š

    1. **åªèƒ½å¼•ç”¨çœŸå®æ¡ˆä¾‹**ï¼šreferenceå­—æ®µåªèƒ½ä»ä¸Šæ–¹ã€å¯å¼•ç”¨çš„ç›¸ä¼¼æ¡ˆä¾‹/æƒå¨è®¤å®šã€‘ä¸­é€‰å–å†…å®¹å¼•ç”¨ã€‚
    2. **ç¦æ­¢è™šæ„æ¡ˆä¾‹**ï¼šç»å¯¹ç¦æ­¢ç¼–é€ ä¸å­˜åœ¨çš„æ¡ˆä¾‹åç§°æˆ–æ¡ˆä¾‹å†…å®¹ï¼
    3. **ç›¸ä¼¼åº¦è¦æ±‚**ï¼šåªæœ‰ç›¸ä¼¼åº¦â‰¥55%ä¸”è¿è§„æœ¬è´¨ç›¸åŒçš„æ¡ˆä¾‹æ‰å¯å¼•ç”¨ã€‚
    4. **ç²¾å‡†åŒ¹é…è¦æ±‚ã€æ–°å¢ã€‘**ï¼š
       - âš ï¸ å¿…é¡»æ£€æŸ¥"è¿è§„æ‰‹æ®µ"å’Œ"é™åˆ¶å¯¹è±¡"æ˜¯å¦éƒ½ä¸€è‡´
       - âœ… æ­£ç¡®ï¼šå½“å‰æ–‡ä»¶"å¯¹è§„ä¸Šä¼ä¸šç»™äºˆå¥–åŠ±" â†â†’ æ¡ˆä¾‹"å°†å¥–åŠ±é™åˆ¶åœ¨è§„ä¸Šä¼ä¸š" ï¼ˆé™åˆ¶å¯¹è±¡ä¸€è‡´ï¼‰
       - âŒ é”™è¯¯ï¼šå½“å‰æ–‡ä»¶"å¯¹è§„ä¸Šä¼ä¸šç»™äºˆå¥–åŠ±" â†â†’ æ¡ˆä¾‹"é¦–æ¬¡è¾¾åˆ°è§„ä¸Šä¼ä¸šå¥–åŠ±" ï¼ˆé™åˆ¶å¯¹è±¡ä¸åŒï¼šå­˜é‡ vs å¢é‡ï¼‰
       - âœ… æ­£ç¡®ï¼šå½“å‰æ–‡ä»¶"æœ¬åœ°ä¼ä¸šä¼˜å…ˆ" â†â†’ æ¡ˆä¾‹"é™å®šæœ¬åœ°ä¼ä¸šå‚ä¸" ï¼ˆé™åˆ¶å¯¹è±¡ä¸€è‡´ï¼‰
       - âŒ é”™è¯¯ï¼šå½“å‰æ–‡ä»¶"è§„æ¨¡ä»¥ä¸Šä¼ä¸š" â†â†’ æ¡ˆä¾‹"å¹´äº§å€¼1000ä¸‡ä»¥ä¸Šä¼ä¸š" ï¼ˆè™½ç„¶éƒ½æ˜¯è§„æ¨¡é™åˆ¶ï¼Œä½†æ ‡å‡†ä¸åŒï¼‰
    5. **å¼•ç”¨æ ¼å¼**ï¼šç›´æ¥å¤åˆ¶ä¸Šæ–¹æ¡ˆä¾‹çš„ã€æ¡ˆä¾‹åŸæ–‡ã€‘éƒ¨åˆ†ï¼Œä¿æŒåŸæ–‡ä¸å˜ã€‚
    6. **æ— æ¡ˆä¾‹æ—¶ç•™ç©º**ï¼šå¦‚æœä¸Šæ–¹æ²¡æœ‰æä¾›ç›¸ä¼¼æ¡ˆä¾‹ï¼Œæˆ–ç›¸ä¼¼åº¦ä¸å¤Ÿï¼Œæˆ–è¿è§„æœ¬è´¨ä¸åŒï¼Œreferenceå­—æ®µå¿…é¡»ä¸ºç©ºå­—ç¬¦ä¸²("")ã€‚

    referenceæ ¼å¼æ¨¡æ¿ï¼ˆä»…å½“æœ‰çœŸå®æ¡ˆä¾‹æ—¶ä½¿ç”¨ï¼‰ï¼š
    "ã€æ¡ˆä¾‹æ ‡é¢˜ï¼ˆæ¥è‡ªä¸Šæ–¹æ£€ç´¢ç»“æœï¼‰ã€‘\\nè¿è§„ç±»å‹ï¼šXXã€‚\\nç›¸ä¼¼åº¦ï¼šXX%ã€‚\\nè¿è§„è¦ç‚¹ï¼šXXã€‚\\nã€æ¡ˆä¾‹åŸæ–‡ã€‘ï¼š\\n(ç›´æ¥å¤åˆ¶ä¸Šæ–¹æ¡ˆä¾‹çš„åŸæ–‡å†…å®¹)"

    **æ¡ˆä¾‹ç­›é€‰æŒ‡å—**ï¼š
    åœ¨å¼•ç”¨æ¡ˆä¾‹å‰ï¼Œè¯·è‡ªé—®ï¼š
    1. å½“å‰é£é™©ç‚¹çš„æ ¸å¿ƒè¿è§„å¯¹è±¡æ˜¯è°ï¼Ÿï¼ˆè§„ä¸Šä¼ä¸š/æœ¬åœ°ä¼ä¸š/å›½æœ‰ä¼ä¸š/ç‰¹å®šå“ç‰Œ...ï¼‰
    2. æ¡ˆä¾‹ä¸­çš„è¿è§„å¯¹è±¡æ˜¯å¦å®Œå…¨ä¸€è‡´ï¼Ÿï¼ˆä¸èƒ½æ˜¯"ç›¸è¿‘"ï¼Œå¿…é¡»æ˜¯"ç›¸åŒ"ï¼‰
    3. è¿è§„æ‰‹æ®µæ˜¯å¦ä¸€è‡´ï¼Ÿï¼ˆé™å®š/ç¦æ­¢/ä¼˜å…ˆ/æŒ‡å®š...ï¼‰
    4. å¦‚æœæ¡ˆä¾‹ä¸­æœ‰"é¦–æ¬¡è¾¾åˆ°"ã€"æ–°å¢"ã€"å¢é‡"ç­‰è¯ï¼Œè€Œå½“å‰æ–‡ä»¶æ²¡æœ‰ï¼Œåˆ™ä¸åŒ¹é…
    5. å¦‚æœæ¡ˆä¾‹ä¸­æ˜¯"å¹´äº§å€¼XXä¸‡"ï¼Œè€Œå½“å‰æ–‡ä»¶æ˜¯"è§„ä¸Šä¼ä¸š"ï¼Œè™½ç„¶éƒ½æ¶‰åŠè§„æ¨¡ï¼Œä½†æ ‡å‡†ä¸åŒï¼Œä¸åŒ¹é…


    // ==========================================
    // ğŸ”¥ é£é™©ç­‰çº§é‡åŒ–æ ‡å‡†
    // ==========================================

    **é£é™©ç­‰çº§åˆ¤å®šæµç¨‹**ï¼ˆè¯·ä¸¥æ ¼æ‰§è¡Œï¼‰ï¼š

    ç»´åº¦1ï¼šé™åˆ¶æ‰‹æ®µ
      - å¼ºåˆ¶æ€§ï¼ˆ"å¿…é¡»"ã€"ä¸å¾—"ã€"ç¦æ­¢"ï¼‰ â†’ +3åˆ†
      - é¼“åŠ±æ€§ï¼ˆ"ä¼˜å…ˆ"ã€"æ”¯æŒ"ï¼‰ â†’ +2åˆ†
      - å»ºè®®æ€§ï¼ˆ"é¼“åŠ±"ã€"å€¡å¯¼"ï¼‰ â†’ +1åˆ†

    ç»´åº¦2ï¼šé™åˆ¶èŒƒå›´
      - æ‰€æœ‰/å¤§å¤šæ•°ç»è¥è€… â†’ +3åˆ†
      - ç‰¹å®šè¡Œä¸š/é¢†åŸŸ â†’ +2åˆ†
      - ä¸ªåˆ«æƒ…å½¢ â†’ +1åˆ†

    ç»´åº¦3ï¼šæ¡ˆä¾‹æ”¯æ’‘
      - æœ‰å®Œå…¨åŒ¹é…æ¡ˆä¾‹ï¼ˆç›¸ä¼¼åº¦>75%ï¼‰ â†’ +3åˆ†
      - æœ‰ä¸­åº¦ç›¸ä¼¼æ¡ˆä¾‹ï¼ˆ60-75%ï¼‰ â†’ +2åˆ†
      - æ— ç›¸ä¼¼æ¡ˆä¾‹ï¼ˆ<60%ï¼‰ â†’ +1åˆ†

    ç»´åº¦4ï¼šæ³•å¾‹æ˜ç¡®æ€§
      - æ˜ç¡®è¿åã€Šæ¡ä¾‹ã€‹ç¦æ­¢æ€§è§„å®š â†’ +3åˆ†
      - ä¸ã€Šæ¡ä¾‹ã€‹ç²¾ç¥ä¸ç¬¦ â†’ +2åˆ†
      - ç°è‰²åœ°å¸¦ â†’ +1åˆ†

    æ€»åˆ†åˆ¤å®šï¼š
    - 10-12åˆ† â†’ High
    - 7-9åˆ† â†’ Medium
    - 4-6åˆ† â†’ Low
    - <4åˆ† â†’ ä¸æ„æˆé£é™©

    è¯·ä»”ç»†é˜…è¯»æ–‡ä»¶å†…å®¹ï¼Œæ‰¾å‡ºæ‰€æœ‰æ½œåœ¨çš„é£é™©ç‚¹ã€‚
    
    **è¿è§„ç±»å‹åˆ†ç±»ä½“ç³»**ï¼ˆç”¨äºå‡†ç¡®åŒ¹é…ç›¸ä¼¼æ¡ˆä¾‹ï¼‰ï¼š
    
    1ï¸âƒ£ **åœ°åŸŸæ€§é™åˆ¶**
    2ï¸âƒ£ **æ‰€æœ‰åˆ¶æ­§è§†**
    3ï¸âƒ£ **è§„æ¨¡/ä¸šç»©é™åˆ¶**
    4ï¸âƒ£ **èµ„è´¨/è£èª‰é™åˆ¶**
    5ï¸âƒ£ **æŒ‡å®šäº¤æ˜“/æ’ä»–æ€§**
    6ï¸âƒ£ **è´¢æ”¿ä¼˜æƒ /è¡¥è´´**
    7ï¸âƒ£ **ä¸åˆç†çš„å‡†å…¥/é€€å‡ºæ¡ä»¶**
    
    **æ¡ˆä¾‹åŒ¹é…åŸåˆ™ï¼ˆç²¾å‡†ä¼˜å…ˆï¼‰**ï¼š
    1. **ç²¾å‡†åŒ¹é…æ‰å¼•ç”¨**ï¼šæ¡ˆä¾‹çš„"è¿è§„æ‰‹æ®µ"+"é™åˆ¶å¯¹è±¡"å¿…é¡»ä¸å½“å‰æ–‡æ¡£**å®Œå…¨ä¸€è‡´**æ‰èƒ½å¼•ç”¨ã€‚
       - ç›¸ä¼¼åº¦â‰¥55%æ˜¯å‰ææ¡ä»¶
       - ä½†ç›¸ä¼¼åº¦é«˜ä¸ä»£è¡¨å¯ä»¥å¼•ç”¨ï¼Œè¿˜è¦æ£€æŸ¥è¿è§„æœ¬è´¨æ˜¯å¦ç›¸åŒ
    2. **æ‹’ç»å¼ºè¡Œå…³è”**ï¼šç¦æ­¢å¼•ç”¨è™½ç„¶å…³é”®è¯ç›¸åŒä½†è¿è§„é€»è¾‘å®Œå…¨ä¸åŒçš„æ¡ˆä¾‹ã€‚
       - æ¡ˆä¾‹ï¼š"é¦–æ¬¡è¾¾åˆ°è§„ä¸Šä¼ä¸šå¥–åŠ±" â‰  å½“å‰ï¼š"è§„ä¸Šä¼ä¸šå¥–åŠ±"ï¼ˆå‰è€…æ˜¯å¢é‡æ¿€åŠ±ï¼Œåè€…æ˜¯å­˜é‡æ­§è§†ï¼‰
       - æ¡ˆä¾‹ï¼š"å¹´äº§å€¼1000ä¸‡ä»¥ä¸Š" â‰  å½“å‰ï¼š"è§„ä¸Šä¼ä¸š"ï¼ˆè™½ç„¶éƒ½æ˜¯è§„æ¨¡é™åˆ¶ï¼Œä½†æ ‡å‡†ä¸åŒï¼‰
    3. **æ³•ç†ä¼˜å…ˆ**ï¼šå¦‚æœæ²¡æœ‰ç²¾å‡†åŒ¹é…çš„æ¡ˆä¾‹ï¼Œè¯·é€šè¿‡ description å­—æ®µå±•ç°æ·±åˆ»çš„æ³•ç†åˆ†æã€‚
    4. **ç©ºå€¼æ ‡å‡†**ï¼šè‹¥æ— åŒ¹é…æ¡ˆä¾‹æˆ–æ²¡æŠŠæ¡ï¼Œreference å­—æ®µå¿…é¡»ç•™ç©ºï¼ˆå³ç©ºå­—ç¬¦ä¸²ï¼‰ï¼Œä¸éœ€è¦ç»™å‡ºä»»ä½•è§£é‡Šè¯´æ˜ã€‚

    referenceæ ¼å¼æ¨¡æ¿ï¼š
    "ã€æ¡ˆä¾‹æ ‡é¢˜ã€‘\nè¿è§„ç±»å‹ï¼šXXã€‚\nç›¸ä¼¼åº¦ï¼šXX%ã€‚\nè¿è§„è¦ç‚¹ï¼šXXã€‚\nå¤„ç†ç»“æœï¼šXXã€‚\nã€æ¡ˆä¾‹åŸæ–‡ã€‘ï¼š\n(ä»ä¸Šä¸‹æ–‡æ‘˜å½•çš„å…³é”®æ®µè½åŸæ–‡)"

    ã€è¾“å‡ºè´¨é‡è¦æ±‚ã€‘
    1. descriptionå­—æ®µï¼ˆ150-300å­—ï¼‰ï¼šæ˜ç¡®è¿è§„ç±»å‹ã€å…·ä½“å†…å®¹ã€è¿è§„åŸå› ã€è¡¥å……è¯´æ˜ã€‚
    2. violated_lawå­—æ®µï¼šå¿…é¡»åŒ…å«å®Œæ•´æ³•æ¡å†…å®¹ã€‚
    3. referenceå­—æ®µï¼š**ä¸¥æ ¼æ‰§è¡Œå®ç¼ºæ¯‹æ»¥åŸåˆ™**ã€‚æ— é«˜åŒ¹é…åº¦æ¡ˆä¾‹æ—¶å¿…é¡»ç•™ç©ºã€‚è‹¥æœ‰åŒ¹é…ï¼Œå¿…é¡»åŒ…å«ã€æ¡ˆä¾‹åŸæ–‡ã€‘ï¼

    è¯·ä»¥ JSON æ•°ç»„æ ¼å¼è¿”å›ç»“æœï¼Œæ¯ä¸ªé£é™©ç‚¹åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
    [
        {
            "id": "risk_1",
            "risk_level": "High" | "Medium" | "Low",
            "description": "...",
            "violated_law": "...",
            "location": "...",
            "suggestion": "...",
            "reference": "ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ¨¡æ¿ï¼Œå¿…é¡»åŒ…å«ã€æ¡ˆä¾‹åŸæ–‡ã€‘ã€‚"
        }
    ]
    `;

    // Use TextChunker for consistent truncation
    const truncatedText = TextChunker.getChunkForAgent(text, 'auditor');

    const userPrompt = `
    æ–‡ä»¶å†…å®¹ï¼š
    ${truncatedText}
    `;

    const resultStr = await callLLM(systemPrompt, userPrompt, true, 'deepseek-reasoner');

    if (!resultStr) {
        return [];
    }

    try {
        const issues = JSON.parse(resultStr) as AuditIssue[];
        // Ensure IDs are unique
        return issues.map((issue, index) => ({ ...issue, id: `risk_${Date.now()}_${index}` }));
    } catch (e) {
        console.error('Failed to parse Auditor JSON:', resultStr);
        return [];
    }
}
