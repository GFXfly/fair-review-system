import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
    console.log('开始修正江苏省2024年度公平竞争审查典型案例数据...');

    // 1. 修正通报信息
    const reportData = {
        title: '2024年全省市场监管部门公平竞争审查抽查整改典型案例发布',
        department: '江苏省市场监督管理局',
        publishDate: '2024-12-31', // 修正为2024年12月31日
        province: '江苏省'
    };

    let report = await prisma.report.findFirst({
        where: { title: reportData.title }
    });

    if (!report) {
        console.log('创建新通报:', reportData.title);
        report = await prisma.report.create({
            data: reportData
        });
    } else {
        console.log('更新已有通报信息, ID:', report.id);
        await prisma.report.update({
            where: { id: report.id },
            data: { publishDate: reportData.publishDate }
        });
        // 为了确保数据准确，先清空旧的（可能包含OCR错误的）案例
        await prisma.case.deleteMany({
            where: { reportId: report.id }
        });
    }

    // 2. 添加7个精准修正后的案例
    const cases = [
        {
            title: '某市公务员局、财政局、卫健委联合指定特定医疗机构作为市级机关工作人员定点体检医院案',
            content: `【文件名称】《关于明确市级机关工作人员定点体检单位的通知》
【违规内容】中“市级机关工作人员定点体检单位为某市人民医院、某市中医院、某健康管理中心、某医院”等内容
【审查解析】违反《公平竞争审查条例》第八条“起草单位起草的政策措施，不得含有下列限制或者变相限制市场准入和退出的内容：（三）限定经营、购买或者使用特定经营者提供的商品或者服务”的规定。
【处理结果】目前文件已整改。`,
            violationType: '限制市场准入和退出',
            result: '已整改',
            documentName: '《关于明确市级机关工作人员定点体检单位的通知》',
            documentOrg: '某市公务员局、财政局、卫健委',
            violationClause: `《公平竞争审查条例》
第八条 起草单位起草的政策措施，不得含有下列限制或者变相限制市场准入和退出的内容：
（三）限定经营、购买或者使用特定经营者提供的商品或者服务。`,
            violationDetail: '直接指定某市人民医院、中医院等特定机构作为定点体检单位，限定交易。',
        },
        {
            title: '某县级市人民政府违规设置准入障碍限制外地机构进入本地开展经营服务案',
            content: `【文件名称】《某市网络预约出租汽车经营服务管理实施细则（试行）》
【违规内容】中“申请从事网约车经营的，应当具备线上线下服务能力，符合下列条件：（一）在本市注册登记的企业法人或者分支机构”等内容
【审查解析】违反《公平竞争审查条例》第八条“起草单位起草的政策措施，不得含有下列限制或者变相限制市场准入和退出的内容：（四）设置不合理或者歧视性的准入、退出条件”的规定。
【处理结果】目前文件已整改。`,
            violationType: '限制市场准入和退出',
            result: '已整改',
            documentName: '《某市网络预约出租汽车经营服务管理实施细则（试行）》',
            documentOrg: '某县级市人民政府',
            violationClause: `《公平竞争审查条例》
第八条 起草单位起草的政策措施，不得含有下列限制或者变相限制市场准入和退出的内容：
（四）设置不合理或者歧视性的准入、退出条件。`,
            violationDetail: '要求申请网约车经营的企业必须在本市注册登记或设立分支机构，设置不合理准入障碍。',
        },
        {
            title: '某市公共资源交易中心指定特定出函机构提供投标保函（保单）业务案',
            content: `【文件名称】《关于公布我市公共资源交易平台投标保函出函机构名单的通知》
【违规内容】中“公布的71家出函机构可供投标人选择办理投标保函（保单）业务，非公布名单中机构出具的保函（保单）文件平台恕不接受”等内容
【审查解析】违反《公平竞争审查条例》第八条“起草单位起草的政策措施，不得含有下列限制或者变相限制市场准入和退出的内容：（三）限定经营、购买或者使用特定经营者提供的商品或者服务”和《招标投标领域公平竞争审查规则》第十一条“政策制定机关制定涉及保证金的政策措施，不得设置以下不合理限制：（四）要求经营主体从特定机构开具保函（保险）”的规定。
【处理结果】目前文件已废止。`,
            violationType: '限制市场准入和退出',
            result: '已整改',
            documentName: '《关于公布我市公共资源交易平台投标保函出函机构名单的通知》',
            documentOrg: '某市公共资源交易中心',
            violationClause: `《公平竞争审查条例》
第八条 起草单位起草的政策措施，不得含有下列限制或者变相限制市场准入和退出的内容：
（三）限定经营、购买或者使用特定经营者提供的商品或者服务。`,
            violationDetail: '指定71家特定出函机构，拒收非名单机构出具的保函，限定交易。',
        },
        {
            title: '某开发区管委会排斥、限制外地经营者参与本地政府采购、招标投标案',
            content: `【文件名称】《2024年零星公告零星工程检测招标公告》
【违规内容】中“三、资格条件。5.外地检测机构必须取得该市建设行政主管部门的备案证明”等内容
【审查解析】违反《公平竞争审查条例》第九条“起草单位起草的政策措施，不得含有下列限制商品、要素自由流动的内容：（三）排斥、限制或者变相限制外地经营者参加本地政府采购、招标投标”。
【处理结果】目前文件已废止。`,
            violationType: '限制商品要素自由流动',
            result: '已整改',
            documentName: '《2024年零星公告零星工程检测招标公告》',
            documentOrg: '某开发区管委会',
            violationClause: `《公平竞争审查条例》
第九条 起草单位起草的政策措施，不得含有下列限制商品、要素自由流动的内容：
（三）排斥、限制或者变相限制外地经营者参加本地政府采购、招标投标。`,
            violationDetail: '要求外地检测机构必须取得本地备案证明才能参与投标，限制外地经营者。',
        },
        {
            title: '某县人民政府要求优先采购本地不锈钢产品案',
            content: `【文件名称】《某县不锈钢产业发展规划》
【违规内容】中“鼓励县域内企业优先采购本地不锈钢制品产品，支持政府公共采购在同等条件下优先购买本地企业产品”等内容
【审查解析】违反《公平竞争审查条例》第八条“起草单位起草的政策措施，不得含有下列限制或者变相限制市场准入和退出的内容：（三）限定经营、购买或者使用特定经营者提供的商品或者服务”的规定。
【处理结果】目前文件已废止。`,
            violationType: '限制市场准入和退出',
            result: '已整改',
            documentName: '《某县不锈钢产业发展规划》',
            documentOrg: '某县人民政府',
            violationClause: `《公平竞争审查条例》
第八条 起草单位起草的政策措施，不得含有下列限制或者变相限制市场准入和退出的内容：
（三）限定经营、购买或者使用特定经营者提供的商品或者服务。`,
            violationDetail: '鼓励优先采购本地产品，支持政府优先购买本地企业产品，限定交易。',
        },
        {
            title: '某市某区人民政府对企业违规设置不合理退出条件案',
            content: `【文件名称】《某区支持企业利用资本市场融资的若干意见》
【违规内容】中“本区企业通过并购重组等方式取得市外上市公司股权并成为第一大股东，境内上市公司注册地、境外上市公司主要生产基地和纳税地迁至本区，且承诺10年内不迁出的，给予一次性补贴1000万元；对注册地和纳税登记地迁入本区的市外上市公司，承诺10年内不迁出的，给予一次性补贴1000万元”等内容
【审查解析】违反《公平竞争审查条例》第八条“起草单位起草的政策措施，不得含有下列限制或者变相限制市场准入和退出的内容：（四）设置不合理或者歧视性的准入、退出条件”；第九条“起草单位起草的政策措施，不得含有下列限制商品、要素自由流动的内容：（二）排斥、限制、强制或者变相强制外地经营者在本地投资经营或者设立分支机构”的规定。
【处理结果】目前文件已整改。`,
            violationType: '限制市场准入和退出',
            result: '已整改',
            documentName: '《某区支持企业利用资本市场融资的若干意见》',
            documentOrg: '某市某区人民政府',
            violationClause: `《公平竞争审查条例》
第八条 ...（四）设置不合理或者歧视性的准入、退出条件。
第九条 ...（二）排斥、限制、强制或者变相强制外地经营者在本地投资经营或者设立分支机构。`,
            violationDetail: '以1000万元补贴为条件，要求企业承诺10年内不迁出，设置不合理退出条件。',
        },
        {
            title: '某县交通运输局违法干预驾校收费价格案',
            content: `【文件名称】《某县机动车驾驶培训行业规范经营指导意见》
【违规内容】中“考虑到城乡差别以及地理位置等因素，城区驾校和乡镇驾校收费可以适当调整，调整幅度不得超过500元，且须报送主管部门备案”等内容
【审查解析】违反了《公平竞争审查条例》第十一条“起草单位起草的政策措施，不得含有下列影响生产经营行为的内容：（三）违法干预实行市场调节价的商品、要素的价格水平”。
【处理结果】目前文件已整改。`,
            violationType: '影响生产经营行为',
            result: '已整改',
            documentName: '《某县机动车驾驶培训行业规范经营指导意见》',
            documentOrg: '某县交通运输局',
            violationClause: `《公平竞争审查条例》
第十一条 起草单位起草的政策措施，不得含有下列影响生产经营行为的内容：
（三）决定或者变相决定实行市场调节价的商品、要素的价格水平。`,
            violationDetail: '限制驾校收费调整幅度不超过500元，并要求备案，违法干预市场调节价。',
        },
    ];

    let count = 0;
    for (const caseData of cases) {
        await prisma.case.create({
            data: {
                ...caseData,
                province: '江苏省',
                publishDate: reportData.publishDate,
                legalScope: '公平竞争审查',
                reportId: report.id
            }
        });
        console.log(`✅ 已添加案例 ${count + 1}:`, caseData.title);
        count++;
    }

    console.log(`\n处理完成，共添加 ${count} 个案例到 Report ID ${report.id}。`);
}

main()
    .catch((e) => {
        console.error(e);
        process.exit(1);
    })
    .finally(async () => {
        await prisma.$disconnect();
    });
